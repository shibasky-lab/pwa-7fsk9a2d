<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>基準点詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
</head>

<body>

<button onclick="history.back()">← 戻る</button>
<h2 style="text-align:center;">基準点詳細</h2>

<section id="pointInfo" style="max-width:600px; margin:auto;"></section>

<hr style="max-width:600px;">

<section style="max-width:600px; margin:auto;">
  <h3>位置</h3>
  <iframe id="gsiMap" width="100%" height="300" style="border:0;"></iframe>
</section>

<hr style="max-width:600px;">

<section style="max-width:600px; margin:auto;">
  <h3>探索履歴</h3>

  <label>
    探索日：
    <input type="date" id="visitDate">
  </label>

  <br><br>

  <label>
    <input type="checkbox" id="foundCheck">
    発見した
  </label>

  <br><br>

  <label>
    メモ：
    <br>
    <textarea id="memo" rows="4" style="width:100%;"></textarea>
  </label>

  <br><br>

  <button id="saveBtn">保存</button>
  <button id="deleteBtn" style="color:red;">履歴削除</button>

  <p id="statusMsg"></p>
</section>

<script type="module">
import { openDB } from "./js/db.js";

const params = new URLSearchParams(location.search);
const pointCode = params.get("code");

async function getByKey(store, key) {
  return new Promise((resolve, reject) => {
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function loadPoint() {
  const db = await openDB();
  const tx = db.transaction("points", "readonly");
  const store = tx.objectStore("points");

  const point = await getByKey(store, pointCode);
  if (!point) return;

  let html = `
    <p><strong>点名：</strong>${point.pointName}</p>
    <p><strong>点種別：</strong>${point.pointType}</p>
    <p><strong>基準点コード：</strong>${point.pointCode}</p>
  `;

  if (point.pointType === "電子基準点" && point.pointNumber) {
    html += `<p><strong>点番号：</strong>${point.pointNumber}</p>`;
  }

  html += `
    <p><strong>所在地：</strong>${point.prefecture}${point.city}</p>
    <p><strong>成果状態：</strong>${point.status}（2025/12/04時点）</p>
    <p><strong>緯度：</strong>${point.lat}</p>
    <p><strong>経度：</strong>${point.lon}</p>
  `;

  document.getElementById("pointInfo").innerHTML = html;

  document.getElementById("gsiMap").src =
    `https://maps.gsi.go.jp/#15/${point.lat}/${point.lon}/&base=std&ls=std&disp=1`;
}

async function loadVisit() {
  const db = await openDB();
  const tx = db.transaction("visits", "readonly");
  const store = tx.objectStore("visits");

  const visit = await getByKey(store, pointCode);
  if (!visit) return;

  document.getElementById("visitDate").value = visit.visitDate;
  document.getElementById("foundCheck").checked = visit.found === 1;
  document.getElementById("memo").value = visit.memo || "";
}

async function saveVisit() {
  const visit = {
    pointCode,
    visitDate: document.getElementById("visitDate").value,
    found: document.getElementById("foundCheck").checked ? 1 : 0,
    memo: document.getElementById("memo").value
  };

  const db = await openDB();
  const tx = db.transaction("visits", "readwrite");
  tx.objectStore("visits").put(visit);

  document.getElementById("statusMsg").textContent = "保存しました";
}

async function deleteVisit() {
  if (!confirm("探索履歴を削除しますか？（写真も削除されます）")) return;

  const db = await openDB();
  const tx = db.transaction("visits", "readwrite");
  tx.objectStore("visits").delete(pointCode);

  document.getElementById("visitDate").value = "";
  document.getElementById("foundCheck").checked = false;
  document.getElementById("memo").value = "";
  document.getElementById("statusMsg").textContent = "削除しました";
}

document.getElementById("saveBtn").onclick = saveVisit;
document.getElementById("deleteBtn").onclick = deleteVisit;

loadPoint();
loadVisit();
</script>

</body>
</html>

