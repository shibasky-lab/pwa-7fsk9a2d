<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>基準点詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 検索に出さない -->
  <meta name="robots" content="noindex,nofollow">
</head>

<body>

<button onclick="history.back()">← 戻る</button>

<h2 style="text-align:center;">基準点詳細</h2>

<section id="pointInfo" style="max-width:600px; margin:auto;">
  <p>読み込み中...</p>
</section>

<hr style="max-width:600px;">

<section style="max-width:600px; margin:auto;">
  <h3>位置</h3>
  <iframe
    id="gsiMap"
    width="100%"
    height="300"
    style="border:0;"
    loading="lazy">
  </iframe>
</section>

<script type="module">
import { openDB } from "./js/db.js";

function getPointCode() {
  const params = new URLSearchParams(location.search);
  return params.get("code");
}

function typeLabel(type) {
  return {
    "電子基準点": "電子",
    "一等三角点": "一等",
    "二等三角点": "二等",
    "三等三角点": "三等",
    "四等三角点": "四等"
  }[type] || type;
}

async function loadPoint() {
  const code = getPointCode();
  if (!code) {
    document.getElementById("pointInfo").innerHTML =
      "<p>基準点コードが指定されていません</p>";
    return;
  }

  const db = await openDB();
  const tx = db.transaction("points", "readonly");
  const store = tx.objectStore("points");

  const point = await new Promise((resolve, reject) => {
    const req = store.get(code);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });

  if (!point) {
    document.getElementById("pointInfo").innerHTML =
      "<p>基準点が見つかりません</p>";
    return;
  }

  let html = `
    <p><strong>点名：</strong>${point.pointName}</p>
    <p><strong>点種別：</strong>${point.pointType}</p>
    <p><strong>基準点コード：</strong>${point.pointCode}</p>
  `;

  if (point.pointType === "電子基準点" && point.pointNumber) {
    html += `<p><strong>点番号：</strong>${point.pointNumber}</p>`;
  }

  html += `
    <p><strong>所在地：</strong>${point.prefecture}${point.city}</p>
    <p><strong>成果状態：</strong>${point.status}（2025/12/04時点）</p>
    <p><strong>緯度：</strong>${point.lat}</p>
    <p><strong>経度：</strong>${point.lon}</p>
  `;

  document.getElementById("pointInfo").innerHTML = html;

  const zoom = 15;
  document.getElementById("gsiMap").src =
    `https://maps.gsi.go.jp/#${zoom}/${point.lat}/${point.lon}/&base=std&ls=std&disp=1`;
}

loadPoint();
</script>

</body>
</html>
