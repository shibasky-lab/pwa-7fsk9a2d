<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>åŸºæº–ç‚¹æ¤œç´¢</title>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>ğŸ“ åŸºæº–ç‚¹æ¤œç´¢</h1>
    <a href="index.html" class="home-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </a>
  </header>

  <main>
    <div class="container">
      <section id="search-section">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="form-group">
          <label>åŸºæº–ç‚¹ç¨®åˆ¥</label>
          <div class="checkbox-group">
            <label><input type="checkbox" class="rank-filter" value="EL0"> é›»å­åŸºæº–ç‚¹</label>
            <label><input type="checkbox" class="rank-filter" value="TR1"> ä¸€ç­‰ä¸‰è§’ç‚¹</label>
            <label><input type="checkbox" class="rank-filter" value="TR2"> äºŒç­‰ä¸‰è§’ç‚¹</label>
            <label><input type="checkbox" class="rank-filter" value="TR3"> ä¸‰ç­‰ä¸‰è§’ç‚¹</label>
            <label><input type="checkbox" class="rank-filter" value="TR4"> å››ç­‰ä¸‰è§’ç‚¹</label>
          </div>
        </div>

        <!-- æ¤œç´¢å…¥åŠ› -->
        <div class="form-group">
          <label for="pref-select">éƒ½é“åºœçœŒ</label>
          <select id="pref-select">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>

        <div class="form-group">
          <label for="name-search">ç‚¹åã§æ¤œç´¢ï¼ˆæ¼¢å­—ãƒ»ã²ã‚‰ãŒãªï¼‰</label>
          <input type="text" id="name-search" placeholder="ç‚¹åã¾ãŸã¯ç‚¹åã®ã²ã‚‰ãŒãªã‚’å…¥åŠ›">
        </div>

        <div class="button-group">
          <button id="search-btn">ğŸ” æ¤œç´¢</button>
          <button id="clear-btn" class="secondary">ğŸ”„ ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- æ¤œç´¢çµæœ -->
        <div id="results">
          <div class="results-header" id="results-header" style="display:none;">
            <span>ğŸ”</span>
            <span id="results-count"></span>
          </div>
          <table id="results-table" style="display:none;">
            <thead>
              <tr>
                <th>ç¨®åˆ¥</th>
                <th>ç‚¹å</th>
                <th>åŸºæº–ç‚¹ã‚³ãƒ¼ãƒ‰</th>
                <th>éƒ½é“åºœçœŒ</th>
                <th>è©³ç´°</th>
              </tr>
            </thead>
            <tbody id="results-tbody">
            </tbody>
          </table>

          <div id="no-results" style="text-align: center; padding: 2rem;">
            <button id="nearby-btn" class="nearby-search-btn">&#128269;è¿‘å‚20ç‚¹</button>
          </div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="pagination" id="pagination" style="display:none;">
          <button id="prev-btn">â† å‰</button>
          <span id="page-info"></span>
          <button id="next-btn">æ¬¡ â†’</button>
        </div>
      </section>
    </div>
  </main>

  <style>
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ */
    header {
      position: relative;
    }

    .home-btn {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 45px;
      height: 45px;
      background: white;
      color: #2196F3;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .home-btn:hover {
      background: #2196F3;
      color: white;
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }

    /* æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾ */
    #search-section {
      background: white;
      padding: 1.2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form-group {
      background: #f8f9fa;
      padding: 0.7rem;
      border-radius: 6px;
      margin-bottom: 0.7rem;
      border-left: 4px solid #2196F3;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
    }

    .form-group input[type="text"],
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input[type="text"]:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      margin: 0;
      font-weight: normal;
      background: white;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .checkbox-group label:hover {
      border-color: #2196F3;
      background: #e3f2fd;
    }

    .checkbox-group input[type="checkbox"]:checked + label,
    .checkbox-group label:has(input[type="checkbox"]:checked) {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 0.4rem;
    }

    /* ä»˜è¿‘æ¤œç´¢ãƒœã‚¿ãƒ³ */
    .nearby-search-btn {
      padding: 0.4rem 0.6rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      white-space: nowrap;
    }

    .nearby-search-btn:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
    }

    .nearby-search-btn:active {
      transform: translateY(1px);
    }

    .nearby-search-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .button-group {
      display: flex;
      gap: 0.7rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 0.7rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #search-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    #search-btn:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #999 0%, #777 100%);
      color: white;
    }

    button.secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(119, 119, 119, 0.4);
    }

    button.secondary:active {
      transform: translateY(0);
    }

    a {
      color: #2196F3;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

      /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
      #results-table {
        border-collapse: collapse;
        width: 100%;
        font-size: 0.9rem;
        table-layout: fixed;
      }

      #results-table th,
      #results-table td {
        border: 1px solid #ddd;
        padding: 0.4rem 0.2rem;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* åˆ—å¹…ã®å›ºå®š */
      #results-table th:nth-child(1),
      #results-table td:nth-child(1) {
        width: 2.5em; /* ç¨®åˆ¥: å…¨è§’2æ–‡å­— */
      }

      #results-table th:nth-child(2),
      #results-table td:nth-child(2) {
        width: auto; /* ç‚¹å: æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ */
        white-space: nowrap;
      }

      #results-table th:nth-child(3),
      #results-table td:nth-child(3) {
        width: 9em; /* åŸºæº–ç‚¹ã‚³ãƒ¼ãƒ‰: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        font-size: 0.8rem;
        padding: 0.4rem 0.1rem;
      }

      #results-table th:nth-child(4),
      #results-table td:nth-child(4) {
        width: 4.5em; /* éƒ½é“åºœçœŒ: å…¨è§’4æ–‡å­— */
      }

      #results-table th:nth-child(5),
      #results-table td:nth-child(5) {
        width: 2.5em; /* è©³ç´°: å…¨è§’2æ–‡å­— */
      }

      #results-table thead tr {
        background: #2196F3;
        color: white;
        border-bottom: 3px solid #1976D2;
      }

      #results-table tbody tr:hover {
        background: #f5f5f5;
      }

      .detail-btn {
        display: inline-block;
        padding: 0.3rem 0.4rem;
        background: #2196F3;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 1rem;
        transition: background 0.2s;
        line-height: 1;
      }

      .detail-btn:hover {
        background: #1976D2;
        text-decoration: none;
      }

      /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7rem;
        margin-top: 1rem;
        padding: 0.7rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .pagination button {
        padding: 0.5rem 1.2rem;
        font-size: 0.85rem;
        border-radius: 6px;
        transition: all 0.2s;
        min-width: auto;
      }

      .pagination button:disabled {
        background: #e0e0e0;
        color: #999;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .pagination button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
      }

      #page-info {
        font-weight: 600;
        color: #333;
        background: #f0f0f0;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      /* æ¤œç´¢çµæœæƒ…å ± */
      #results {
        margin-top: 1.2rem;
      }

      .results-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.7rem 1rem;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      #results-table {
        border-radius: 0 0 8px 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
  </style>

  <script type="module">
    import KijuntenDB from './src/db.js'
    import { getLabel } from './src/metadata.js'

    const db = new KijuntenDB()
    const PAGE_SIZE = 20
    let currentPage = 1
    let searchResults = []
    let allBases = []
    let prefNames = {} // éƒ½é“åºœçœŒãƒã‚¹ã‚¿
    let searchMode = 'normal' // 'normal' or 'nearby'

    await db.init()

    // éƒ½é“åºœçœŒãƒã‚¹ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    try {
      const res = await fetch('data/pref_ids.json')
      if (res.ok) {
        prefNames = await res.json()
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«é¸æŠè‚¢ã‚’è¿½åŠ 
        const prefSelect = document.getElementById('pref-select')
        Object.keys(prefNames).sort().forEach(prefId => {
          const option = document.createElement('option')
          option.value = prefId
          option.textContent = prefNames[prefId]
          prefSelect.appendChild(option)
        })
      }
    } catch (err) {
      console.warn('Failed to load pref_ids.json:', err)
    }

    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    allBases = await db.getAllBases()

    if (allBases.length === 0) {
      document.getElementById('no-results').innerHTML = '<p style="color: #f44336;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<a href="/">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a>ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>'
    }

    const nameSearchInput = document.getElementById('name-search')
    const prefSelect = document.getElementById('pref-select')
    const rankFilters = document.querySelectorAll('.rank-filter')
    const searchBtn = document.getElementById('search-btn')
    const nearbyBtn = document.getElementById('nearby-btn')
    const clearBtn = document.getElementById('clear-btn')
    const resultsTable = document.getElementById('results-table')
    const resultsTbody = document.getElementById('results-tbody')
    const noResults = document.getElementById('no-results')
    const pagination = document.getElementById('pagination')
    const pageInfo = document.getElementById('page-info')
    const prevBtn = document.getElementById('prev-btn')
    const nextBtn = document.getElementById('next-btn')

    // Haversineè·é›¢è¨ˆç®—é–¢æ•° (kmå˜ä½ã§è¿”ã™)
    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371 // åœ°çƒã®åŠå¾„ (km)
      const dLat = (lat2 - lat1) * Math.PI / 180
      const dLon = (lon2 - lon1) * Math.PI / 180
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2)
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
      return R * c
    }

    searchBtn.addEventListener('click', async () => {
      searchMode = 'normal'
      let rankIds = Array.from(rankFilters)
        .filter(cb => cb.checked)
        .map(cb => cb.value)
      
      // TR4ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€EK0ã‚‚è‡ªå‹•çš„ã«å«ã‚ã‚‹
      if (rankIds.includes('TR4') && !rankIds.includes('EK0')) {
        rankIds.push('EK0')
      }
      // EK0ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€TR4ã‚‚è‡ªå‹•çš„ã«å«ã‚ã‚‹
      if (rankIds.includes('EK0') && !rankIds.includes('TR4')) {
        rankIds.push('TR4')
      }
      
      const searchQuery = nameSearchInput.value
      const selectedPrefId = prefSelect.value
      
      const filters = {
        rankIds,
        nameQuery: searchQuery,
        nameKanaQuery: searchQuery,
        prefId: selectedPrefId
      }

      searchResults = await db.searchBases(filters)
      // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰é †ã€ç‚¹ç¨®åˆ¥é †ã§ã‚½ãƒ¼ãƒˆ
      sortResults()
      currentPage = 1
      displayResults()
    })

    // ã‚½ãƒ¼ãƒˆé–¢æ•°ï¼šéƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰é † â†’ ç‚¹ç¨®åˆ¥é †
    function sortResults() {
      const rankOrder = { 'EL0': 1, 'TR1': 2, 'TR2': 3, 'TR3': 4, 'TR4': 5, 'EK0': 5 }
      searchResults.sort((a, b) => {
        // ç¬¬ä¸€å„ªå…ˆ: éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰
        if (a.pref_id !== b.pref_id) {
          return a.pref_id.localeCompare(b.pref_id)
        }
        // ç¬¬äºŒå„ªå…ˆ: ç‚¹ç¨®åˆ¥
        const aRank = rankOrder[a.rank_id] || 99
        const bRank = rankOrder[b.rank_id] || 99
        return aRank - bRank
      })
    }

    nearbyBtn.addEventListener('click', async () => {
      searchMode = 'nearby'
      
      // ä½ç½®æƒ…å ±ã‚’å–å¾—
      if (!navigator.geolocation) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚')
        return
      }

      nearbyBtn.disabled = true
      nearbyBtn.innerHTML = '&#128269;å–å¾—ä¸­...'

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude
          const userLon = position.coords.longitude

          // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ç‚¹ç¨®åˆ¥ã‚’å–å¾—
          let rankIds = Array.from(rankFilters)
            .filter(cb => cb.checked)
            .map(cb => cb.value)
          
          // TR4ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€EK0ã‚‚è‡ªå‹•çš„ã«å«ã‚ã‚‹
          if (rankIds.includes('TR4') && !rankIds.includes('EK0')) {
            rankIds.push('EK0')
          }
          // EK0ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€TR4ã‚‚è‡ªå‹•çš„ã«å«ã‚ã‚‹
          if (rankIds.includes('EK0') && !rankIds.includes('TR4')) {
            rankIds.push('TR4')
          }

          // åŸºæº–ç‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Œã°ãã®ç¨®åˆ¥ã®ã¿ã€ãªã‘ã‚Œã°å…¨ã¦ï¼‰
          let targetBases = allBases
          if (rankIds.length > 0) {
            targetBases = allBases.filter(base => rankIds.includes(base.rank_id))
          }

          // è·é›¢ã‚’è¨ˆç®—ã—ã¦è¿½åŠ 
          searchResults = targetBases.map(base => {
            const distance = calcDistance(userLat, userLon, base.lat, base.lon)
            return { ...base, distance }
          })

          // è·é›¢ã§ã‚½ãƒ¼ãƒˆï¼ˆæ˜‡é †ï¼‰
          searchResults.sort((a, b) => a.distance - b.distance)

          // ä¸Šä½20ä»¶ã®ã¿å–å¾—
          searchResults = searchResults.slice(0, 20)

          currentPage = 1
          displayResults()

          nearbyBtn.disabled = false
          nearbyBtn.innerHTML = '&#128269;è¿‘å‚20ç‚¹'
        },
        (error) => {
          let message = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
          if (error.code === error.PERMISSION_DENIED) {
            message = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            message = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚'
          } else if (error.code === error.TIMEOUT) {
            message = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚'
          }
          alert(message)
          nearbyBtn.disabled = false
          nearbyBtn.innerHTML = '&#128269;è¿‘å‚20ç‚¹'
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      )
    })

    clearBtn.addEventListener('click', () => {
      searchMode = 'normal'
      rankFilters.forEach(cb => cb.checked = false)
      nameSearchInput.value = ''
      prefSelect.value = ''
      searchResults = []
      currentPage = 1
      resultsTable.style.display = 'none'
      document.getElementById('results-header').style.display = 'none'
      noResults.style.display = 'block'
      pagination.style.display = 'none'
    })

    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--
        displayResults()
      }
    })

    nextBtn.addEventListener('click', () => {
      const maxPage = Math.ceil(searchResults.length / PAGE_SIZE)
      if (currentPage < maxPage) {
        currentPage++
        displayResults()
      }
    })

    function displayResults() {
      const resultsHeader = document.getElementById('results-header')
      const resultsCount = document.getElementById('results-count')
      
      if (searchResults.length === 0) {
        resultsTable.style.display = 'none'
        resultsHeader.style.display = 'none'
        noResults.style.display = 'block'
        pagination.style.display = 'none'
        return
      }

      const maxPage = Math.ceil(searchResults.length / PAGE_SIZE)
      const start = (currentPage - 1) * PAGE_SIZE
      const end = start + PAGE_SIZE
      const pageResults = searchResults.slice(start, end)
      
      // æ¤œç´¢çµæœæ•°ã‚’è¡¨ç¤º
      resultsCount.textContent = `æ¤œç´¢çµæœ: ${searchResults.length}ä»¶`
      resultsHeader.style.display = 'flex'

      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‹•çš„ã«å¤‰æ›´
      const tableHead = resultsTable.querySelector('thead tr')
      if (searchMode === 'nearby') {
        tableHead.innerHTML = `
          <th>ç¨®åˆ¥</th>
          <th>ç‚¹å</th>
          <th>è·é›¢</th>
          <th>éƒ½é“åºœçœŒ</th>
          <th>è©³ç´°</th>
        `
      } else {
        tableHead.innerHTML = `
          <th>ç¨®åˆ¥</th>
          <th>ç‚¹å</th>
          <th>åŸºæº–ç‚¹ã‚³ãƒ¼ãƒ‰</th>
          <th>éƒ½é“åºœçœŒ</th>
          <th>è©³ç´°</th>
        `
      }

      resultsTbody.innerHTML = pageResults.map(base => {
        const prefName = prefNames[base.pref_id] || '-'
        // ç¨®åˆ¥ã‚’çŸ­ç¸®è¡¨ç¤º
        const rankLabel = getLabel('rank_ids', base.rank_id)
        let shortRank = rankLabel
        if (rankLabel.includes('é›»å­')) shortRank = 'é›»å­'
        else if (rankLabel.includes('ä¸€ç­‰')) shortRank = 'ä¸€ç­‰'
        else if (rankLabel.includes('äºŒç­‰')) shortRank = 'äºŒç­‰'
        else if (rankLabel.includes('ä¸‰ç­‰')) shortRank = 'ä¸‰ç­‰'
        else if (rankLabel.includes('å››ç­‰')) shortRank = 'å››ç­‰'
        
        // nearbyãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è·é›¢ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
        if (searchMode === 'nearby' && base.distance !== undefined) {
          let distanceText = ''
          if (base.distance < 1) {
            distanceText = `${Math.round(base.distance * 1000)}m`
          } else {
            distanceText = `${base.distance.toFixed(2)}km`
          }
          
          return `
          <tr>
            <td>${shortRank}</td>
            <td>${base.name || '-'}</td>
            <td>${distanceText}</td>
            <td>${prefName}</td>
            <td><a href="detail.html?id=${base.id}" class="detail-btn" title="è©³ç´°ã‚’è¡¨ç¤º">ğŸ“–</a></td>
          </tr>
        `
        } else {
          return `
          <tr>
            <td>${shortRank}</td>
            <td>${base.name || '-'}</td>
            <td><code style="font-size: 0.75rem;">${base.id}</code></td>
            <td>${prefName}</td>
            <td><a href="detail.html?id=${base.id}" class="detail-btn" title="è©³ç´°ã‚’è¡¨ç¤º">ğŸ“–</a></td>
          </tr>
        `
        }
      }).join('')

      pageInfo.textContent = `${currentPage}/${maxPage}ï¼ˆå…¨${searchResults.length}ä»¶ï¼‰`

      resultsTable.style.display = 'table'
      noResults.style.display = 'none'
      pagination.style.display = 'flex'

      prevBtn.disabled = currentPage === 1
      nextBtn.disabled = currentPage === maxPage
    }
  </script>
</body>
</html>
