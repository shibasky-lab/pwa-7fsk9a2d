<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="åŸºæº–ç‚¹æ¤œç´¢ãƒ»æ¢ç´¢è¨˜éŒ²ã‚¢ãƒ—ãƒª">
  <meta name="theme-color" content="#2196F3">
  <title>åŸºæº–ç‚¹æ¤œç´¢ - PWA</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    section {
      background: white;
      padding: 1.2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8rem;
      margin: 1.2rem 0;
    }

    .menu-card {
      padding: 1.2rem;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: none;
    }

    .menu-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .menu-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.4rem;
    }

    /* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ãƒœãƒƒã‚¯ã‚¹ */
    .status-box {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .status-box h3 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      color: #333;
      font-size: 1rem;
    }

    .db-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.7rem;
      margin: 0.8rem 0;
    }

    .stat-item {
      text-align: center;
      background: white;
      padding: 0.8rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.3rem;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.4rem 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.8rem;
    }

    /* ã‚¢ãƒ—ãƒªç´¹ä»‹ãƒœãƒƒã‚¯ã‚¹ */
    .info-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .info-box h3 {
      color: #1976D2;
      margin-top: 0;
      margin-bottom: 0.7rem;
      font-size: 1rem;
    }

    .info-box p {
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 0.5rem 0;
    }

    .info-box ul {
      margin: 0.7rem 0;
      padding-left: 1.3rem;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .info-box ul li {
      margin-bottom: 0.3rem;
    }

    .info-box a {
      color: #1976D2;
      text-decoration: none;
      word-break: break-all;
    }

    .info-box a:hover {
      text-decoration: underline;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      backdrop-filter: blur(4px);
      padding: 1rem;
      overflow-y: auto;
    }

    #loading-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading-overlay .progress-bar {
      background: rgba(255, 255, 255, 0.3);
      width: 80vw;
      max-width: 600px;
      margin: 1rem 0;
    }

    #loading-overlay .progress-bar-fill {
      background: linear-gradient(90deg, #4CAF50, #2196F3);
    }

    #loading-overlay #progress-text {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    #loading-overlay #file-list-container {
      background: transparent;
      color: white;
      width: 80vw;
      max-width: 600px;
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      border-radius: 8px;
      margin-top: 1rem;
      scrollbar-width: none; /* Firefox */
      font-size: 0.8rem;
    }

    #loading-overlay #file-list-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    #loading-overlay #file-list-container strong {
      font-size: 0.85rem;
      color: white;
    }

    #loading-overlay #file-list {
      margin: 0.4rem 0 0 1rem;
      padding: 0;
      list-style: disc;
      font-size: 0.75rem;
    }

    #loading-overlay #file-list li {
      margin-bottom: 0.2rem;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .menu-grid {
        grid-template-columns: 1fr;
      }

      .db-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
  </div>

  <header>
    <h1>ğŸ“ åŸºæº–ç‚¹æ¤œç´¢ PWA</h1>
  </header>

  <main>
    <div class="container">
      <section>
        <div class="status-box">
          <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³</h3>
          <div id="db-status">
            <p>åˆæœŸåŒ–ä¸­...</p>
          </div>
          <div class="db-stats" id="db-stats" style="display:none;">
            <div class="stat-item">
              <div class="stat-value" id="stat-bases">-</div>
              <div class="stat-label">åŸºæº–ç‚¹æƒ…å ±</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-visits">-</div>
              <div class="stat-label">è¨ªå•å±¥æ­´</div>
            </div>
          </div>
        </div>

        <div class="menu-grid">
          <a href="search.html" class="menu-card">
            <span class="menu-icon">ğŸ”</span>
            åŸºæº–ç‚¹æ¤œç´¢
          </a>
          <a href="visit.html" class="menu-card">
            <span class="menu-icon">ğŸ“</span>
            è¨ªå•å±¥æ­´
          </a>
          <a href="sokusetsu.html" class="menu-card">
            <span class="menu-icon">ğŸ¯</span>
            æ¸¬è¨­ãƒ¢ãƒ¼ãƒ‰
          </a>
          <a href="setting.html" class="menu-card">
            <span class="menu-icon">âš™ï¸</span>
            è¨­å®š
          </a>
        </div>

        <div class="info-box" id="install-prompt" style="display: none; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
          <h3 style="color: #2e7d32;">ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
          <p>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
            <button id="install-btn" style="flex: 1; padding: 0.7rem; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
            <button id="install-cancel-btn" style="padding: 0.7rem 1.2rem; background: white; color: #666; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">å¾Œã§</button>
          </div>
        </div>

        <div class="info-box">
          <h3>ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
          <p>å›½åœŸåœ°ç†é™¢ãŒå…¬é–‹ã™ã‚‹åŸºæº–ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€é›»å­åŸºæº–ç‚¹ãƒ»ä¸‰è§’ç‚¹ã®æ¤œç´¢ã€æ¢ç´¢è¨˜éŒ²ãŒå¯èƒ½ã§ã™ã€‚</p>
          <ul>
            <li>ğŸ“ å…¨å›½ã®åŸºæº–ç‚¹æƒ…å ±ï¼ˆé›»å­åŸºæº–ç‚¹ã€ä¸€ç­‰ï½å››ç­‰ä¸‰è§’ç‚¹ï¼‰</li>
            <li>ğŸ’¾ åˆå›ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ä½¿ç”¨å¯èƒ½</li>
            <li>ğŸ“ æ¢ç´¢å±¥æ­´ã¨å†™çœŸã‚’è¨˜éŒ²</li>
            <li>ğŸ—ºï¸ åœ°ç†é™¢åœ°å›³ã§ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª</li>
            <li>ğŸ¯ GPSæ©Ÿèƒ½ã§æ¸¬è¨­ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</li>
          </ul>
          <p style="font-size: 0.8rem; color: #666; margin: 0.8rem 0 0 0;">
            å‡ºå…¸ï¼šå›½åœŸåœ°ç†é™¢ï¼ˆåŸºæº–ç‚¹æˆæœç­‰é–²è¦§ã‚µãƒ¼ãƒ“ã‚¹ï¼‰<br>
            <a href="https://service.gsi.go.jp/kijunten/" target="_blank">https://service.gsi.go.jp/kijunten/</a>
          </p>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import KijuntenDB from './src/db.js'

    const db = new KijuntenDB()
    const dbStatus = document.getElementById('db-status')
    const dbStats = document.getElementById('db-stats')

    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    let deferredPrompt = null
    const installPrompt = document.getElementById('install-prompt')
    const installBtn = document.getElementById('install-btn')
    const installCancelBtn = document.getElementById('install-cancel-btn')

    window.addEventListener('beforeinstallprompt', (e) => {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ‘åˆ¶
      e.preventDefault()
      deferredPrompt = e
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      installPrompt.style.display = 'block'
    })

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return
      
      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      deferredPrompt.prompt()
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠçµæœã‚’å¾…ã¤
      const { outcome } = await deferredPrompt.userChoice
      console.log(`User response to the install prompt: ${outcome}`)
      
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤º
      installPrompt.style.display = 'none'
      deferredPrompt = null
    })

    installCancelBtn.addEventListener('click', () => {
      installPrompt.style.display = 'none'
    })

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã—ãªã„
    window.addEventListener('appinstalled', () => {
      installPrompt.style.display = 'none'
      deferredPrompt = null
    })

    // Service Worker ã®ç™»éŒ²
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('Service Worker registered:', registration.scope)
        })
        .catch(err => {
          console.error('Service Worker registration failed:', err)
        })
    }

    // DBåˆæœŸåŒ–
    async function initDB() {
      try {
        await db.init()
        await updateDBStatus()
        // åˆå›èµ·å‹•æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã® data/points_XX.json ã‚’èª­ã¿è¾¼ã‚“ã§ IndexedDB ã«ä¿å­˜
        const size = await db.getSize()
        const initialDone = await db.getMetadata('initial_import_done')
        if (size.bases === 0 && !initialDone) {
          // è‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€
          await loadLocalData()
        }
      } catch (error) {
        console.error('DB init error:', error)
        dbStatus.innerHTML = '<p style="color: #f44336;">ã‚¨ãƒ©ãƒ¼: IndexedDBã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</p>'
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ« data/points_01..47.json ã‚’é †æ¬¡èª­ã¿è¾¼ã¿ DB ã«ç™»éŒ²
    async function loadLocalData() {
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
      const loadingOverlay = document.getElementById('loading-overlay')
      loadingOverlay.classList.remove('hidden')

      try {
        // é€²æ—è¡¨ç¤ºè¦ç´ ã‚’ä½œæˆï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«ç›´æ¥è¿½åŠ ï¼‰
        const progressDiv = document.createElement('div')
        progressDiv.id = 'download-progress'
        progressDiv.innerHTML = `
          <p id="progress-text">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div id="file-list-container">
            <strong style="font-size:0.95rem;">èª­ã¿è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«:</strong>
            <ul id="file-list"></ul>
          </div>
        `
        loadingOverlay.appendChild(progressDiv)

        const progressText = document.getElementById('progress-text')
        const progressFill = document.getElementById('progress-fill')
        const fileList = document.getElementById('file-list')

        // ã¾ãšãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª­ã¿è¾¼ã¿
        const masterFiles = [
          'data/pref_ids.json',
          'data/quality_ids.json',
          'data/attachment_ids.json',
          'data/result_status_ids.json',
          'data/result_division_ids.json',
          'data/reconstruction_status_ids.json',
          'data/attr_status_ids.json',
          'data/land_type_ids.json'
        ]

        progressText.textContent = 'ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...'
        for (const path of masterFiles) {
          try {
            const res = await fetch(path)
            if (!res.ok) throw new Error(`HTTP ${res.status}`)
            const data = await res.json()
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚­ãƒ¼ã‚’æŠ½å‡ºï¼ˆä¾‹ï¼špref_ids.json â†’ pref_idsï¼‰
            const key = path.split('/').pop().replace('.json', '')
            await db.setMetadata(key, data)
            
            if (fileList) {
              const li = document.createElement('li')
              li.textContent = path + ` â€” ${Object.keys(data).length}ä»¶`
              fileList.appendChild(li)
            }
          } catch (err) {
            console.warn('Failed loading', path, err)
          }
        }

        // åŸºæº–ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const total = 47
        for (let i = 1; i <= total; i++) {
          const idx = String(i).padStart(2, '0')
          const path = `data/points_${idx}.json`
          progressText.textContent = `èª­ã¿è¾¼ã¿: ${path}`
          try {
            const res = await fetch(path)
            if (!res.ok) throw new Error(`HTTP ${res.status}`)
            const arr = await res.json()
            if (Array.isArray(arr) && arr.length > 0) {
              // bases ã«è¿½åŠ ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã§è¿½åŠ ï¼‰
              await db.addBases(arr)
              // èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦å¯è¦–åŒ–
              if (fileList) {
                const li = document.createElement('li')
                li.textContent = path + ` â€” ${arr.length.toLocaleString()}ä»¶`
                fileList.appendChild(li)
              }
            }
          } catch (err) {
            console.warn('Failed loading', path, err)
          }

          const pct = Math.round((i / total) * 100)
          progressFill.style.width = pct + '%'
        }

        // å®Œäº†ãƒãƒ¼ã‚¯
        await db.setMetadata('initial_import_done', true)
        progressText.textContent = 'âœ“ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿å®Œäº†'
        progressFill.style.width = '100%'
        await new Promise(r => setTimeout(r, 800))
        progressDiv.style.display = 'none'
        updateDBStatus()
      } catch (error) {
        console.error('Local import error:', error)
        const progressText = document.getElementById('progress-text')
        if (progressText) {
          progressText.textContent = 'âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼'
        }
      } finally {
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
        const loadingOverlay = document.getElementById('loading-overlay')
        loadingOverlay.classList.add('hidden')
      }
    }

    // DBçŠ¶æ³æ›´æ–°
    async function updateDBStatus() {
      try {
        const size = await db.getSize()
        
        // è¨ªå•å±¥æ­´æ•°ã‚’å–å¾—
        const visitCount = await getVisitCount()
        
        if (size.bases === 0) {
          dbStatus.innerHTML = '<p style="color: #FF9800;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'
        } else {
          dbStatus.innerHTML = '<p style="color: #4CAF50;">âœ“ ãƒ‡ãƒ¼ã‚¿ã¯åˆ©ç”¨å¯èƒ½ã§ã™</p>'
        }

        document.getElementById('stat-bases').textContent = size.bases.toLocaleString()
        document.getElementById('stat-visits').textContent = visitCount.toLocaleString()
        dbStats.style.display = 'grid'
      } catch (error) {
        console.error('Error updating DB status:', error)
      }
    }

    // è¨ªå•å±¥æ­´æ•°ã‚’å–å¾—
    function getVisitCount() {
      return new Promise((resolve) => {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šãªã—ã§ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é–‹ã
        const request = indexedDB.open('visitHistoryDB')
        
        request.onsuccess = (event) => {
          const db = event.target.result
          
          if (!db.objectStoreNames.contains('visits')) {
            db.close()
            resolve(0)
            return
          }
          
          const transaction = db.transaction(['visits'], 'readonly')
          const store = transaction.objectStore('visits')
          const countRequest = store.count()
          
          countRequest.onsuccess = () => {
            db.close()
            resolve(countRequest.result)
          }
          
          countRequest.onerror = () => {
            db.close()
            resolve(0)
          }
        }
        
        request.onerror = () => resolve(0)
      })
    }

    // åˆæœŸåŒ–
    await initDB()
  </script>
</body>
</html>
