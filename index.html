<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 検索除外 -->
  <meta name="robots" content="noindex, nofollow">

  <title>基準点探索PWA</title>

  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">

  <script defer src="js/db.js"></script>
  <script defer src="js/points.js"></script>
  <script defer src="js/visits.js"></script>
  <script defer src="js/photos.js"></script>
</head>

<body>

<!-- ================= メニュー画面 ================= -->
<section id="menu-view" class="view">
  <h1>基準点探索</h1>

  <button onclick="showView('search-view')">基準点検索</button>
  <button disabled>探索履歴閲覧（準備中）</button>
  <button disabled>データ表示（準備中）</button>
</section>

<!-- ================= 基準点検索画面 ================= -->
<section id="search-view" class="view hidden">
  <h2>基準点検索</h2>

  <!-- 検索条件 -->
  <div>
    <label>
      点名<br>
      <input type="text" id="search-name" placeholder="例：〇〇山">
    </label>
  </div>

  <fieldset>
    <legend>点種別</legend>
    <label style="white-space: nowrap;"><input type="checkbox" class="search-type" value="電子基準点" checked> 電子基準点</label>
    <label style="white-space: nowrap;"><input type="checkbox" class="search-type" value="一等三角点" checked> 一等三角点</label>
    <label style="white-space: nowrap;"><input type="checkbox" class="search-type" value="二等三角点" checked> 二等三角点</label>
    <label style="white-space: nowrap;"><input type="checkbox" class="search-type" value="三等三角点" checked> 三等三角点</label>
    <label style="white-space: nowrap;"><input type="checkbox" class="search-type" value="四等三角点" checked> 四等三角点</label>
  </fieldset>

  <div>
    <label>
      都道府県<br>
      <select id="search-prefecture">
        <option value="">すべて</option>
        <option value="北海道">北海道</option>
        <option value="青森県">青森県</option>
        <option value="岩手県">岩手県</option>
      </select>
    </label>
  </div>

  <div style="margin-top: 1em;">
    <button onclick="runDummySearch()">検索</button>
  </div>

  <!-- 検索結果 -->
  <div style="margin-top:1em; overflow-x:auto;">
    <table border="1" width="100%" style="text-align:center;">
      <thead>
        <tr>
          <th>点種</th>
          <th>点名</th>
          <th>基準点コード</th>
          <th>都道府県</th>
          <th>詳細</th>
        </tr>
      </thead>
      <tbody id="results-body">
      </tbody>
    </table>
  </div>

  <!-- ページング -->
  <div style="margin-top:0.5em;">
    <button onclick="prevPage()">前の20件</button>
    <span id="page-info">0 / 0</span>
    <button onclick="nextPage()">次の20件</button>
  </div>

  <button onclick="showView('menu-view')">戻る</button>
</section>

<script>
  const PAGE_SIZE = 20;
  let currentPage = 0;
  let searchResults = [];

  function runSearch() {
    const name = document.getElementById("search-name").value.trim();
    const prefecture = document.getElementById("search-prefecture").value;

    const types = Array.from(document.querySelectorAll(".search-type:checked"))
      .map(cb => cb.value);

    searchResults = [];
    currentPage = 0;

    const request = indexedDB.open("benchmarkDB");

    request.onsuccess = (event) => {
      const db = event.target.result;
      const tx = db.transaction("points", "readonly");
      const store = tx.objectStore("points");

      store.openCursor().onsuccess = (e) => {
        const cursor = e.target.result;
        if (!cursor) {
          renderPage();
          return;
        }

        const p = cursor.value;

        // 点名（部分一致）
        if (name && !p.name.includes(name)) {
          cursor.continue();
          return;
        }

        // 点種別
        if (!types.includes(p.type)) {
          cursor.continue();
          return;
        }

        // 都道府県
        if (prefecture && p.prefecture !== prefecture) {
          cursor.continue();
          return;
        }

        searchResults.push(p);
        cursor.continue();
      };
    };
  }

  function renderPage() {
    const tbody = document.getElementById("results-body");
    tbody.innerHTML = "";

    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageItems = searchResults.slice(start, end);

    pageItems.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${shortType(p.type)}</td>
        <td>${p.name}</td>
        <td>${p.code}</td>
        <td>${p.prefecture}</td>
        <td><button onclick="openDetail('${p.code}')">詳細</button></td>
      `;
      tbody.appendChild(tr);
    });

    const totalPages = Math.ceil(searchResults.length / PAGE_SIZE);
    document.getElementById("page-info").textContent =
      totalPages === 0 ? "0 / 0" : `${currentPage + 1} / ${totalPages}`;
  }

  function nextPage() {
    const totalPages = Math.ceil(searchResults.length / PAGE_SIZE);
    if (currentPage < totalPages - 1) {
      currentPage++;
      renderPage();
    }
  }

  function prevPage() {
    if (currentPage > 0) {
      currentPage--;
      renderPage();
    }
  }

  function openDetail(code) {
    console.log("詳細表示:", code);
    // 次のSTEPで実装
    showView("detail-view");
  }

  function shortType(type) {
    if (type === "電子基準点") return "電子";
    if (type === "一等三角点") return "一等";
    if (type === "二等三角点") return "二等";
    if (type === "三等三角点") return "三等";
    if (type === "四等三角点") return "四等";
    return type;
  }
</script>


<!-- ================= 詳細画面 ================= -->
<section id="detail-view" class="view hidden">
  <h2>基準点詳細</h2>

  <p>※ 詳細情報は後で実装</p>

  <button onclick="showView('search-view')">戻る</button>
</section>

<!-- ================= 探索履歴入力画面 ================= -->
<section id="visit-form-view" class="view hidden">
  <h2>探索履歴入力</h2>

  <p>※ 履歴入力フォームは後で実装</p>

  <button onclick="showView('detail-view')">戻る</button>
</section>

<script>
  function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => {
      v.classList.add('hidden');
    });
    document.getElementById(viewId).classList.remove('hidden');
  }
</script>

</body>
</html>



