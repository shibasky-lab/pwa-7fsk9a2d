<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>å±¥æ­´å…¥åŠ›</title>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem;
      box-sizing: border-box;
    }

    header {
      background: white;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      border-radius: 8px;
      position: relative;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      color: #333;
    }

    .base-info {
      background: white;
      padding: 1rem;
      padding-right: 60px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      position: relative;
    }

    .base-info .rank {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }

    .base-info .name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    .form-section {
      background: white;
      padding: 1.2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #2196F3;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .checkbox-group label {
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
    }

    .photo-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .photo-item {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 1rem;
      transition: border-color 0.2s;
    }

    .photo-item.has-photo {
      border-style: solid;
      border-color: #4CAF50;
    }

    .photo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .photo-label {
      font-weight: bold;
      color: #333;
    }

    .photo-btn {
      padding: 0.5rem 1rem;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .photo-btn:hover {
      background: #1976D2;
    }

    .photo-preview {
      display: none;
      position: relative;
      margin-top: 0.5rem;
    }

    .photo-preview.show {
      display: block;
    }

    .photo-preview img {
      width: 100%;
      max-width: 360px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .photo-preview .remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .photo-preview .remove-btn:hover {
      background: rgba(244, 67, 54, 1);
    }

    textarea.form-input {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .submit-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .delete-btn {
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: 2px solid rgba(244, 67, 54, 0.3);
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .delete-btn:hover {
      background: rgba(244, 67, 54, 1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .loading, .error {
      text-align: center;
      padding: 2rem;
      color: white;
    }

    .error {
      background: rgba(244, 67, 54, 0.9);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    /* ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .crop-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      padding: 1rem;
      overflow: auto;
    }

    .crop-modal.show {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .crop-container {
      position: relative;
      display: inline-block;
      max-width: 90vw;
      max-height: 70vh;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    .crop-image {
      display: block;
      max-width: 100%;
      max-height: 70vh;
      user-select: none;
    }

    .crop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .crop-frame {
      position: absolute;
      border: 2px solid #4CAF50;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      cursor: move;
      pointer-events: auto;
    }

    .crop-frame::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 30px;
      border: 2px solid #4CAF50;
      border-radius: 50%;
      pointer-events: none;
    }

    .crop-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #4CAF50;
      border: 2px solid white;
      border-radius: 50%;
      pointer-events: auto;
    }

    .crop-handle.nw { top: -10px; left: -10px; cursor: nw-resize; }
    .crop-handle.ne { top: -10px; right: -10px; cursor: ne-resize; }
    .crop-handle.sw { bottom: -10px; left: -10px; cursor: sw-resize; }
    .crop-handle.se { bottom: -10px; right: -10px; cursor: se-resize; }

    .crop-controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .crop-controls button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .crop-controls .confirm-btn {
      background: #4CAF50;
      color: white;
    }

    .crop-controls .confirm-btn:hover {
      background: #45a049;
    }

    .crop-controls .cancel-btn {
      background: #f44336;
      color: white;
    }

    .crop-controls .cancel-btn:hover {
      background: #da190b;
    }

    input[type="file"] {
      display: none;
    }

    .photo-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.25rem;
    }

    /* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    .delete-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .delete-modal.show {
      display: flex;
    }

    .delete-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 85%;
      width: 380px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      text-align: center;
    }

    .delete-modal-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #f44336;
      margin-bottom: 1rem;
    }

    .delete-modal-message {
      font-size: 1rem;
      color: #333;
      margin-bottom: 2rem;
    }

    .delete-modal-buttons {
      display: flex;
      gap: 1rem;
    }

    .delete-modal-btn {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-modal-btn.yes {
      background: #f44336;
      color: white;
    }

    .delete-modal-btn.yes:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .delete-modal-btn.no {
      background: #e0e0e0;
      color: #333;
    }

    .delete-modal-btn.no:hover {
      background: #bdbdbd;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="page-title">ğŸ“ å±¥æ­´å…¥åŠ›</h1>
    </header>

    <div id="loading" class="loading">
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="content" style="display: none;">
      <div class="base-info">
        <button id="delete-btn" class="delete-btn" style="display: none;" onclick="showDeleteModal()">ğŸ—‘ï¸ å‰Šé™¤</button>
        <div class="rank" id="base-rank"></div>
        <div class="name" id="base-name"></div>
      </div>

      <form id="visit-form" class="form-section">
        <div class="form-group">
          <label class="form-label" for="visit-date">æ¢ç´¢æ—¥</label>
          <input type="date" id="visit-date" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">æ¢ç´¢çµæœ</label>
          <div class="checkbox-group">
            <input type="checkbox" id="found" checked>
            <label for="found">åŸºæº–ç‚¹ã‚’ç™ºè¦‹ã—ãŸ</label>
          </div>
          <div class="photo-info">â€» ãƒã‚§ãƒƒã‚¯ãªã— = è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸ</div>
        </div>

        <div class="form-group">
          <label class="form-label">å†™çœŸç™»éŒ²</label>
          <div class="photo-section">
            <!-- è¿‘æ™¯ -->
            <div class="photo-item" id="near-photo-item">
              <div class="photo-header">
                <span class="photo-label">ğŸ“· è¿‘æ™¯</span>
                <button type="button" class="photo-btn" onclick="selectPhoto('near')">å†™çœŸã‚’é¸æŠ</button>
              </div>
              <div class="photo-info">ç¸¦é•· 3:4 ã«è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™</div>
              <div class="photo-preview" id="near-preview">
                <img id="near-preview-img" alt="è¿‘æ™¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <button type="button" class="remove-btn" onclick="removePhoto('near')">Ã—</button>
              </div>
            </div>

            <!-- é æ™¯ -->
            <div class="photo-item" id="far-photo-item">
              <div class="photo-header">
                <span class="photo-label">ğŸï¸ é æ™¯</span>
                <button type="button" class="photo-btn" onclick="selectPhoto('far')">å†™çœŸã‚’é¸æŠ</button>
              </div>
              <div class="photo-info">ç¸¦é•· 3:4 ã«è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™</div>
              <div class="photo-preview" id="far-preview">
                <img id="far-preview-img" alt="é æ™¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <button type="button" class="remove-btn" onclick="removePhoto('far')">Ã—</button>
              </div>
            </div>
          </div>
          <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoSelect(event)">
        </div>

        <div class="form-group">
          <label class="form-label" for="memo">ãƒ¡ãƒ¢</label>
          <textarea id="memo" class="form-input" placeholder="æ¢ç´¢æ™‚ã®çŠ¶æ³ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’è¨˜éŒ²"></textarea>
        </div>

        <button type="submit" class="submit-btn">ğŸ’¾ ç™»éŒ²ã™ã‚‹</button>
      </form>
    </div>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="delete-modal" id="delete-modal">
    <div class="delete-modal-content">
      <div class="delete-modal-title">ğŸ—‘ï¸ æ¢ç´¢å±¥æ­´ã®å‰Šé™¤</div>
      <div class="delete-modal-message">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="delete-modal-buttons">
        <button class="delete-modal-btn yes" onclick="confirmDelete()">ã¯ã„</button>
        <button class="delete-modal-btn no" onclick="closeDeleteModal()">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="crop-modal" id="crop-modal">
    <div class="crop-container" id="crop-container">
      <img id="crop-image" class="crop-image" alt="ãƒˆãƒªãƒŸãƒ³ã‚°å¯¾è±¡">
      <div class="crop-overlay">
        <div class="crop-frame" id="crop-frame">
          <div class="crop-handle nw"></div>
          <div class="crop-handle ne"></div>
          <div class="crop-handle sw"></div>
          <div class="crop-handle se"></div>
        </div>
      </div>
    </div>
    <div class="crop-controls">
      <button type="button" class="confirm-btn" onclick="confirmCrop()">âœ“ ç¢ºå®š</button>
      <button type="button" class="cancel-btn" onclick="cancelCrop()">Ã— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <script type="module">
    import KijuntenDB from './src/db.js'
    import { getLabel, ensureMasterDataLoaded } from './src/metadata.js'
    const db = new KijuntenDB()
    
    let currentPhotoType = null // 'near' or 'far'
    let currentImage = null
    let nearPhotoData = null
    let farPhotoData = null
    let baseData = null

    const loading = document.getElementById('loading')
    const error = document.getElementById('error')
    const content = document.getElementById('content')
    const cropModal = document.getElementById('crop-modal')
    const cropContainer = document.getElementById('crop-container')
    const cropImage = document.getElementById('crop-image')
    const cropFrame = document.getElementById('crop-frame')
    
    // ãƒˆãƒªãƒŸãƒ³ã‚°æ ã®çŠ¶æ…‹
    let cropRect = { x: 0, y: 0, width: 0, height: 0 }
    let isDragging = false
    let isResizing = false
    let resizeHandle = null
    let dragStartX = 0
    let dragStartY = 0
    let originalCropRect = null

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åŸºæº–ç‚¹IDã‚’å–å¾—
    const params = new URLSearchParams(window.location.search)
    const baseId = params.get('id')
    const visitId = params.get('visitId') // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ãƒã‚§ãƒƒã‚¯
    const isEditMode = visitId !== null

    if (!baseId) {
      error.textContent = 'ã‚¨ãƒ©ãƒ¼: åŸºæº–ç‚¹IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'
      error.style.display = 'block'
      loading.style.display = 'none'
    } else {
      loadBaseData()
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    if (isEditMode) {
      document.getElementById('page-title').textContent = 'ğŸ“ å±¥æ­´ç·¨é›†'
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã‚»ãƒƒãƒˆ
    document.getElementById('visit-date').valueAsDate = new Date()

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if (isEditMode) {
      document.getElementById('delete-btn').style.display = 'block'
    }

    async function loadBaseData() {
      try {
        await db.init()
        await ensureMasterDataLoaded()

        baseData = await db.getBase(baseId)

        if (!baseData) {
          error.textContent = 'ã‚¨ãƒ©ãƒ¼: åŸºæº–ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          error.style.display = 'block'
          loading.style.display = 'none'
          return
        }

        // ç‚¹ç¨®åˆ¥ã®å–å¾—
        const rankLabel = getLabel('rank_ids', baseData.rank_id) || 'ä¸æ˜'
        let shortRank = rankLabel
        if (rankLabel.includes('é›»å­')) shortRank = 'é›»å­åŸºæº–ç‚¹'
        else if (rankLabel.includes('ä¸€ç­‰')) shortRank = 'ä¸€ç­‰ä¸‰è§’ç‚¹'
        else if (rankLabel.includes('äºŒç­‰')) shortRank = 'äºŒç­‰ä¸‰è§’ç‚¹'
        else if (rankLabel.includes('ä¸‰ç­‰')) shortRank = 'ä¸‰ç­‰ä¸‰è§’ç‚¹'
        
        // åŸºæº–ç‚¹æƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('base-rank').textContent = shortRank
        document.getElementById('base-name').textContent = baseData.name

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        loading.style.display = 'none'
        content.style.display = 'block'
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        if (isEditMode) {
          await loadVisitData(visitId)
          // é€ä¿¡ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
          document.querySelector('.submit-btn').textContent = 'ğŸ’¾ æ›´æ–°ã™ã‚‹'
        }
      } catch (err) {
        console.error('Error loading base data:', err)
        error.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'
        error.style.display = 'block'
        loading.style.display = 'none'
      }
    }

    async function loadVisitData(visitId) {
      try {
        const visitData = await getVisitById(parseInt(visitId))
        
        if (!visitData) {
          // å±¥æ­´ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
          console.warn('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚')
          return
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        document.getElementById('visit-date').value = visitData.visitDate
        document.getElementById('found').checked = visitData.found
        document.getElementById('memo').value = visitData.memo || ''

        // è¿‘æ™¯å†™çœŸ
        if (visitData.nearPhoto) {
          nearPhotoData = visitData.nearPhoto
          document.getElementById('near-preview-img').src = visitData.nearPhoto
          document.getElementById('near-preview').classList.add('show')
          document.getElementById('near-photo-item').classList.add('has-photo')
        }

        // é æ™¯å†™çœŸ
        if (visitData.farPhoto) {
          farPhotoData = visitData.farPhoto
          document.getElementById('far-preview-img').src = visitData.farPhoto
          document.getElementById('far-preview').classList.add('show')
          document.getElementById('far-photo-item').classList.add('has-photo')
        }
      } catch (err) {
        console.error('Error loading visit data:', err)
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦ç¶šè¡Œ
      }
    }

    function getVisitById(visitId) {
      return new Promise((resolve, reject) => {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šãªã—ã§ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é–‹ã
        const request = indexedDB.open('visitHistoryDB')

        request.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'))

        request.onsuccess = (event) => {
          const db = event.target.result

          if (!db.objectStoreNames.contains('visits')) {
            db.close()
            resolve(null)
            return
          }

          const transaction = db.transaction(['visits'], 'readonly')
          const store = transaction.objectStore('visits')
          const getRequest = store.get(visitId)

          getRequest.onsuccess = () => {
            db.close()
            resolve(getRequest.result)
          }

          getRequest.onerror = () => {
            db.close()
            reject(new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'))
          }
        }

        request.onupgradeneeded = (event) => {
          const db = event.target.result
          if (!db.objectStoreNames.contains('visits')) {
            const objectStore = db.createObjectStore('visits', { keyPath: 'visitId', autoIncrement: true })
            objectStore.createIndex('baseId', 'baseId', { unique: false })
            objectStore.createIndex('visitDate', 'visitDate', { unique: false })
          }
        }
      })
    }

    function selectPhoto(type) {
      currentPhotoType = type
      document.getElementById('photo-input').click()
    }

    function handlePhotoSelect(event) {
      const file = event.target.files[0]
      if (!file) return

      const reader = new FileReader()
      reader.onload = (e) => {
        const img = new Image()
        img.onload = () => {
          currentImage = img
          showCropModal()
        }
        img.src = e.target.result
      }
      reader.readAsDataURL(file)

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ï¼‰
      event.target.value = ''
    }

    function showCropModal() {
      cropModal.classList.add('show')
      
      // ç”»åƒã‚’è¡¨ç¤º
      cropImage.src = currentImage.src
      
      // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒˆãƒªãƒŸãƒ³ã‚°æ ã‚’åˆæœŸåŒ–
      cropImage.onload = () => {
        initCropFrame()
      }
    }

    function initCropFrame() {
      const img = cropImage
      const imgWidth = img.width
      const imgHeight = img.height
      const displayWidth = img.clientWidth
      const displayHeight = img.clientHeight
      
      // è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿéš›ã®ã‚µã‚¤ã‚ºã®æ¯”ç‡
      const scale = displayWidth / imgWidth
      
      const targetRatio = 3 / 4
      
      // åˆæœŸãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ã‚’ç”»åƒã®ä¸­å¤®ã«è¨­å®š
      let frameWidth, frameHeight
      
      if (displayWidth / displayHeight > targetRatio) {
        // ç”»åƒãŒæ¨ªé•·ã®å ´åˆã€é«˜ã•åŸºæº–
        frameHeight = displayHeight * 0.8
        frameWidth = frameHeight * targetRatio
      } else {
        // ç”»åƒãŒç¸¦é•·ã®å ´åˆã€å¹…åŸºæº–
        frameWidth = displayWidth * 0.8
        frameHeight = frameWidth / targetRatio
      }
      
      // æœ€å¤§ã‚µã‚¤ã‚ºã‚’åˆ¶é™
      if (frameWidth > displayWidth) {
        frameWidth = displayWidth
        frameHeight = frameWidth / targetRatio
      }
      if (frameHeight > displayHeight) {
        frameHeight = displayHeight
        frameWidth = frameHeight * targetRatio
      }
      
      cropRect = {
        x: (displayWidth - frameWidth) / 2,
        y: (displayHeight - frameHeight) / 2,
        width: frameWidth,
        height: frameHeight
      }
      
      updateCropFrame()
      setupCropEvents()
    }

    function updateCropFrame() {
      cropFrame.style.left = cropRect.x + 'px'
      cropFrame.style.top = cropRect.y + 'px'
      cropFrame.style.width = cropRect.width + 'px'
      cropFrame.style.height = cropRect.height + 'px'
    }

    function setupCropEvents() {
      // ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•
      cropFrame.addEventListener('mousedown', startDrag)
      cropFrame.addEventListener('touchstart', startDrag, { passive: false })
      
      // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«
      const handles = cropFrame.querySelectorAll('.crop-handle')
      handles.forEach(handle => {
        handle.addEventListener('mousedown', startResize)
        handle.addEventListener('touchstart', startResize, { passive: false })
      })
      
      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§move/endã‚’ç›£è¦–
      document.addEventListener('mousemove', handleMove)
      document.addEventListener('mouseup', endDragOrResize)
      document.addEventListener('touchmove', handleMove, { passive: false })
      document.addEventListener('touchend', endDragOrResize)
    }

    function startDrag(e) {
      if (e.target.classList.contains('crop-handle')) return
      
      e.preventDefault()
      e.stopPropagation()
      
      isDragging = true
      const point = getEventPoint(e)
      dragStartX = point.x - cropRect.x
      dragStartY = point.y - cropRect.y
      originalCropRect = { ...cropRect }
    }

    function startResize(e) {
      e.preventDefault()
      e.stopPropagation()
      
      isResizing = true
      resizeHandle = e.target.classList[1] // nw, ne, sw, se
      const point = getEventPoint(e)
      dragStartX = point.x
      dragStartY = point.y
      originalCropRect = { ...cropRect }
    }

    function handleMove(e) {
      if (!isDragging && !isResizing) return
      
      e.preventDefault()
      const point = getEventPoint(e)
      
      if (isDragging) {
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•
        const containerRect = cropImage.getBoundingClientRect()
        let newX = point.x - dragStartX
        let newY = point.y - dragStartY
        
        // ç”»åƒå†…ã«åˆ¶é™
        newX = Math.max(0, Math.min(newX, cropImage.clientWidth - cropRect.width))
        newY = Math.max(0, Math.min(newY, cropImage.clientHeight - cropRect.height))
        
        cropRect.x = newX
        cropRect.y = newY
        updateCropFrame()
      } else if (isResizing) {
        // ãƒªã‚µã‚¤ã‚º
        const deltaX = point.x - dragStartX
        const deltaY = point.y - dragStartY
        const targetRatio = 3 / 4
        
        let newWidth = originalCropRect.width
        let newHeight = originalCropRect.height
        let newX = originalCropRect.x
        let newY = originalCropRect.y
        
        // å„ã‚³ãƒ¼ãƒŠãƒ¼ã«å¿œã˜ã¦ãƒªã‚µã‚¤ã‚º
        if (resizeHandle === 'se') {
          // å³ä¸‹: é«˜ã•åŸºæº–ã§ãƒªã‚µã‚¤ã‚º
          newHeight = originalCropRect.height + deltaY
          newWidth = newHeight * targetRatio
        } else if (resizeHandle === 'sw') {
          // å·¦ä¸‹: é«˜ã•åŸºæº–ã§ãƒªã‚µã‚¤ã‚º
          newHeight = originalCropRect.height + deltaY
          newWidth = newHeight * targetRatio
          newX = originalCropRect.x - (newWidth - originalCropRect.width)
        } else if (resizeHandle === 'ne') {
          // å³ä¸Š: é«˜ã•åŸºæº–ã§ãƒªã‚µã‚¤ã‚º
          newHeight = originalCropRect.height - deltaY
          newWidth = newHeight * targetRatio
          newY = originalCropRect.y + deltaY
        } else if (resizeHandle === 'nw') {
          // å·¦ä¸Š: é«˜ã•åŸºæº–ã§ãƒªã‚µã‚¤ã‚º
          newHeight = originalCropRect.height - deltaY
          newWidth = newHeight * targetRatio
          newX = originalCropRect.x - (newWidth - originalCropRect.width)
          newY = originalCropRect.y + deltaY
        }
        
        // æœ€å°ã‚µã‚¤ã‚º
        const minSize = 50
        if (newWidth < minSize || newHeight < minSize / targetRatio) return
        
        // ç”»åƒå†…ã«åˆ¶é™
        if (newX < 0 || newY < 0 || 
            newX + newWidth > cropImage.clientWidth || 
            newY + newHeight > cropImage.clientHeight) return
        
        cropRect = { x: newX, y: newY, width: newWidth, height: newHeight }
        updateCropFrame()
      }
    }

    function endDragOrResize() {
      isDragging = false
      isResizing = false
      resizeHandle = null
    }

    function getEventPoint(e) {
      const containerRect = cropImage.getBoundingClientRect()
      let clientX, clientY
      
      if (e.type.startsWith('touch')) {
        clientX = e.touches[0].clientX
        clientY = e.touches[0].clientY
      } else {
        clientX = e.clientX
        clientY = e.clientY
      }
      
      return {
        x: clientX - containerRect.left,
        y: clientY - containerRect.top
      }
    }

    function confirmCrop() {
      // è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿéš›ã®ç”»åƒã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
      const img = currentImage
      const displayWidth = cropImage.clientWidth
      const scale = img.width / displayWidth
      
      // å®Ÿéš›ã®ç”»åƒã‹ã‚‰ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹åº§æ¨™ã¨ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
      const sourceX = cropRect.x * scale
      const sourceY = cropRect.y * scale
      const sourceWidth = cropRect.width * scale
      const sourceHeight = cropRect.height * scale
      
      // 360x480ã®æœ€çµ‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
      const finalCanvas = document.createElement('canvas')
      finalCanvas.width = 360
      finalCanvas.height = 480
      const ctx = finalCanvas.getContext('2d')
      
      // å…ƒç”»åƒã‹ã‚‰ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã‚’æŒ‡å®šã‚µã‚¤ã‚ºã§æç”»
      ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, 360, 480)
      
      // Data URLã¨ã—ã¦å–å¾—
      const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.85)
      
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
      if (currentPhotoType === 'near') {
        nearPhotoData = dataUrl
        document.getElementById('near-preview-img').src = dataUrl
        document.getElementById('near-preview').classList.add('show')
        document.getElementById('near-photo-item').classList.add('has-photo')
      } else if (currentPhotoType === 'far') {
        farPhotoData = dataUrl
        document.getElementById('far-preview-img').src = dataUrl
        document.getElementById('far-preview').classList.add('show')
        document.getElementById('far-photo-item').classList.add('has-photo')
      }

      cancelCrop()
    }

    function cancelCrop() {
      cropModal.classList.remove('show')
      currentImage = null
      currentPhotoType = null
    }

    function removePhoto(type) {
      if (type === 'near') {
        nearPhotoData = null
        document.getElementById('near-preview').classList.remove('show')
        document.getElementById('near-photo-item').classList.remove('has-photo')
      } else if (type === 'far') {
        farPhotoData = null
        document.getElementById('far-preview').classList.remove('show')
        document.getElementById('far-photo-item').classList.remove('has-photo')
      }
    }

    // é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
    window.selectPhoto = selectPhoto
    window.handlePhotoSelect = handlePhotoSelect
    window.confirmCrop = confirmCrop
    window.cancelCrop = cancelCrop
    window.removePhoto = removePhoto
    window.showDeleteModal = showDeleteModal
    window.closeDeleteModal = closeDeleteModal
    window.confirmDelete = confirmDelete

    function showDeleteModal() {
      document.getElementById('delete-modal').classList.add('show')
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.remove('show')
    }

    async function confirmDelete() {
      try {
        await deleteVisitHistory(parseInt(visitId))
        alert('æ¢ç´¢å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ')
        window.location.href = `detail.html?id=${baseId}`
      } catch (err) {
        console.error('Error deleting visit history:', err)
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message)
      }
      closeDeleteModal()
    }

    function deleteVisitHistory(visitId) {
      return new Promise((resolve, reject) => {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šãªã—ã§ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é–‹ã
        const request = indexedDB.open('visitHistoryDB')

        request.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'))

        request.onsuccess = (event) => {
          const db = event.target.result

          if (!db.objectStoreNames.contains('visits')) {
            db.close()
            resolve()
            return
          }

          const transaction = db.transaction(['visits'], 'readwrite')
          const store = transaction.objectStore('visits')
          const deleteRequest = store.delete(visitId)

          deleteRequest.onsuccess = () => {
            db.close()
            resolve()
          }

          deleteRequest.onerror = () => {
            db.close()
            reject(new Error('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'))
          }
        }
      })
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('visit-form').addEventListener('submit', async (e) => {
      e.preventDefault()

      const submitBtn = e.target.querySelector('.submit-btn')
      submitBtn.disabled = true
      submitBtn.textContent = 'ä¿å­˜ä¸­...'

      try {
        const visitData = {
          baseId: baseId,
          baseName: baseData.name,
          baseRank: document.getElementById('base-rank').textContent,
          visitDate: document.getElementById('visit-date').value,
          found: document.getElementById('found').checked,
          nearPhoto: nearPhotoData,
          farPhoto: farPhotoData,
          memo: document.getElementById('memo').value.trim(),
          createdAt: new Date().toISOString()
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯visitIdã‚’è¿½åŠ 
        if (isEditMode) {
          visitData.visitId = parseInt(visitId)
        }

        // IndexedDBã«ä¿å­˜
        await saveVisitHistory(visitData, isEditMode)

        alert(isEditMode ? 'æ¢ç´¢å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¢ç´¢å±¥æ­´ã‚’ç™»éŒ²ã—ã¾ã—ãŸ')
        window.location.href = `detail.html?id=${baseId}`
      } catch (err) {
        console.error('Error saving visit history:', err)
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message)
        submitBtn.disabled = false
        submitBtn.textContent = isEditMode ? 'ğŸ’¾ æ›´æ–°ã™ã‚‹' : 'ğŸ’¾ ç™»éŒ²ã™ã‚‹'
      }
    })

    function saveVisitHistory(visitData, isUpdate = false) {
      return new Promise((resolve, reject) => {
        // ã¾ãšãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã„ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        const checkRequest = indexedDB.open('visitHistoryDB')
        
        checkRequest.onsuccess = (event) => {
          const db = event.target.result
          const needsUpgrade = !db.objectStoreNames.contains('visits')
          const currentVersion = db.version
          db.close()
          
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ãŒå¿…è¦ãªå ´åˆã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã¦å†ä½œæˆ
          const targetVersion = needsUpgrade ? currentVersion + 1 : currentVersion
          const request = indexedDB.open('visitHistoryDB', targetVersion)
          
          request.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'))
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result
            if (!db.objectStoreNames.contains('visits')) {
              const objectStore = db.createObjectStore('visits', { keyPath: 'visitId', autoIncrement: true })
              objectStore.createIndex('baseId', 'baseId', { unique: false })
              objectStore.createIndex('visitDate', 'visitDate', { unique: false })
            }
          }
          
          request.onsuccess = (event) => {
            const db = event.target.result
            const transaction = db.transaction(['visits'], 'readwrite')
            const store = transaction.objectStore('visits')
            
            // æ›´æ–°ã®å ´åˆã¯putã€æ–°è¦ã®å ´åˆã¯add
            const saveRequest = isUpdate ? store.put(visitData) : store.add(visitData)

            saveRequest.onsuccess = () => {
              db.close()
              resolve()
            }

            saveRequest.onerror = () => {
              db.close()
              reject(new Error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'))
            }
          }
        }
        
        checkRequest.onerror = () => {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
          const request = indexedDB.open('visitHistoryDB', 1)
          
          request.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'))
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result
            if (!db.objectStoreNames.contains('visits')) {
              const objectStore = db.createObjectStore('visits', { keyPath: 'visitId', autoIncrement: true })
              objectStore.createIndex('baseId', 'baseId', { unique: false })
              objectStore.createIndex('visitDate', 'visitDate', { unique: false })
            }
          }
          
          request.onsuccess = (event) => {
            const db = event.target.result
            const transaction = db.transaction(['visits'], 'readwrite')
            const store = transaction.objectStore('visits')
            
            const saveRequest = isUpdate ? store.put(visitData) : store.add(visitData)

            saveRequest.onsuccess = () => {
              db.close()
              resolve()
            }

            saveRequest.onerror = () => {
              db.close()
              reject(new Error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'))
            }
          }
        }
      })
    }
  </script>
</body>
</html>
