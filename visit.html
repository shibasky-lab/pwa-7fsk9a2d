<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>è¨ªå•å±¥æ­´ãƒãƒƒãƒ—</title>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow: hidden;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .header-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
      text-decoration: none;
    }

    .header-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* åœ°å›³ */
    #map {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* åœ°å›³ä¸Šã®ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ */
    .map-list-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 45px;
      height: 45px;
      background: white;
      color: #667eea;
      border: 2px solid #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: right 0.3s;
      z-index: 2100;
    }

    .map-list-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* ãƒªã‚¹ãƒˆãŒé–‹ã„ãŸã¨ãã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
    .map-list-btn.hidden {
      display: none;
    }

    /* ãƒªã‚¹ãƒˆãƒ‘ãƒãƒ« */
    .list-panel {
      position: fixed;
      top: 60px;
      right: -100%;
      width: 80%;
      max-width: 280px;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      z-index: 2000;
      transition: right 0.3s;
      display: flex;
      flex-direction: column;
    }

    .list-panel.show {
      right: 0;
    }

    .list-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }

    .list-header h2 {
      font-size: 1.1rem;
      margin: 0;
    }

    .list-controls {
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .search-box {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .search-box:focus {
      outline: none;
      border-color: #667eea;
    }

    .sort-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .sort-btn {
      flex: 1;
      padding: 0.5rem;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sort-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .list-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .list-item {
      background: rgba(249, 249, 249, 0.7);
      border: 2px solid rgba(224, 224, 224, 0.8);
      border-radius: 8px;
      padding: 0.6rem;
      margin-bottom: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: rgba(240, 240, 240, 0.9);
      border-color: #667eea;
    }

    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }

    .list-item-name {
      font-weight: bold;
      color: #333;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-item-rank {
      font-size: 0.7rem;
      color: #666;
      background: #e0e0e0;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      white-space: nowrap;
    }

    .list-item-info {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.75rem;
      color: #666;
    }

    .list-item-date {
      color: #667eea;
      font-weight: 600;
    }

    .no-results {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ */
    .custom-marker {
      background: #667eea;
      border: 3px solid white;
      border-radius: 50% 50% 50% 0;
      width: 30px;
      height: 30px;
      transform: rotate(-45deg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .custom-marker::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚«ã‚¹ã‚¿ãƒ  */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      padding: 0;
    }

    .popup-content {
      padding: 0.75rem;
      min-width: 200px;
    }

    .popup-rank {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 0.25rem;
    }

    .popup-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .popup-info {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.75rem;
    }

    .popup-btn {
      display: block;
      width: 100%;
      padding: 0.6rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      text-align: center;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .popup-btn:hover {
      transform: scale(1.02);
    }

    .popup-btn:visited {
      color: white !important;
    }

    .popup-btn:active {
      color: white !important;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header>
    <h1>ğŸ—ºï¸ è¨ªå•å±¥æ­´ãƒãƒƒãƒ—</h1>
    <div class="header-buttons">
      <a href="index.html" class="header-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </a>
    </div>
  </header>

  <!-- åœ°å›³ -->
  <div id="map">
    <button class="map-list-btn" id="list-btn" title="ãƒªã‚¹ãƒˆè¡¨ç¤º">ğŸ“‹</button>
  </div>

  <!-- ãƒªã‚¹ãƒˆãƒ‘ãƒãƒ« -->
  <div class="list-panel" id="list-panel">
    <div class="list-header">
      <h2>è¨ªå•å±¥æ­´ãƒªã‚¹ãƒˆ</h2>
    </div>
    
    <div class="list-controls">
      <input type="text" class="search-box" id="search-box" placeholder="ç‚¹åã§æ¤œç´¢...">
      
      <select class="search-box" id="pref-filter" style="margin-bottom: 0.75rem;">
        <option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option>
      </select>
      
      <div class="sort-buttons">
        <button class="sort-btn active" data-sort="date">ğŸ“… æ¢ç´¢æ—¥é †</button>
        <button class="sort-btn" data-sort="rank">ğŸ”ï¸ ç‚¹ç¨®åˆ¥é †</button>
      </div>
    </div>
    
    <div class="list-content" id="list-content">
      <div class="no-results">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import KijuntenDB from './src/db.js'
    import { getLabel, ensureMasterDataLoaded } from './src/metadata.js'

    const db = new KijuntenDB()
    let map = null
    let markers = []
    let allVisits = []
    let currentSort = 'date'
    let prefList = []

    // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ã‹ã‚‰åå‰ã¸ã®å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«
    const PREF_NAMES = {
      '01': 'åŒ—æµ·é“', '02': 'é’æ£®çœŒ', '03': 'å²©æ‰‹çœŒ', '04': 'å®®åŸçœŒ', '05': 'ç§‹ç”°çœŒ',
      '06': 'å±±å½¢çœŒ', '07': 'ç¦å³¶çœŒ', '08': 'èŒ¨åŸçœŒ', '09': 'æ ƒæœ¨çœŒ', '10': 'ç¾¤é¦¬çœŒ',
      '11': 'åŸ¼ç‰çœŒ', '12': 'åƒè‘‰çœŒ', '13': 'æ±äº¬éƒ½', '14': 'ç¥å¥ˆå·çœŒ', '15': 'æ–°æ½ŸçœŒ',
      '16': 'å¯Œå±±çœŒ', '17': 'çŸ³å·çœŒ', '18': 'ç¦äº•çœŒ', '19': 'å±±æ¢¨çœŒ', '20': 'é•·é‡çœŒ',
      '21': 'å²é˜œçœŒ', '22': 'é™å²¡çœŒ', '23': 'æ„›çŸ¥çœŒ', '24': 'ä¸‰é‡çœŒ', '25': 'æ»‹è³€çœŒ',
      '26': 'äº¬éƒ½åºœ', '27': 'å¤§é˜ªåºœ', '28': 'å…µåº«çœŒ', '29': 'å¥ˆè‰¯çœŒ', '30': 'å’Œæ­Œå±±çœŒ',
      '31': 'é³¥å–çœŒ', '32': 'å³¶æ ¹çœŒ', '33': 'å²¡å±±çœŒ', '34': 'åºƒå³¶çœŒ', '35': 'å±±å£çœŒ',
      '36': 'å¾³å³¶çœŒ', '37': 'é¦™å·çœŒ', '38': 'æ„›åª›çœŒ', '39': 'é«˜çŸ¥çœŒ', '40': 'ç¦å²¡çœŒ',
      '41': 'ä½è³€çœŒ', '42': 'é•·å´çœŒ', '43': 'ç†Šæœ¬çœŒ', '44': 'å¤§åˆ†çœŒ', '45': 'å®®å´çœŒ',
      '46': 'é¹¿å…å³¶çœŒ', '47': 'æ²–ç¸„çœŒ'
    }

    // åˆæœŸåŒ–
    async function init() {
      try {
        await db.init()
        await ensureMasterDataLoaded()

        // åœ°å›³ã‚’åˆæœŸåŒ–
        initMap()

        // å…¨è¨ªå•å±¥æ­´ã‚’å–å¾—
        allVisits = await getAllVisitsWithBaseInfo()

        if (allVisits.length === 0) {
          document.getElementById('loading').classList.add('hidden')
          alert('è¨ªå•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“')
          return
        }

        // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        addMarkersToMap(allVisits)

        // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        await populatePrefList()

        // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆåˆå›ã¯æ¢ç´¢æ—¥é †ã§ã‚½ãƒ¼ãƒˆï¼‰
        filterAndSort()

        // åœ°å›³ã‚’å…¨ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«èª¿æ•´
        if (markers.length > 0) {
          const group = L.featureGroup(markers)
          map.fitBounds(group.getBounds().pad(0.1))
        }

        document.getElementById('loading').classList.add('hidden')
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error)
        document.getElementById('loading').classList.add('hidden')
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    }

    // åœ°å›³ã‚’åˆæœŸåŒ–
    function initMap() {
      map = L.map('map', {
        zoomControl: false
      }).setView([36.5, 138.0], 6)

      L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>',
        maxZoom: 18
      }).addTo(map)
    }

    // å…¨è¨ªå•å±¥æ­´ã‚’åŸºæº–ç‚¹æƒ…å ±ã¨å…±ã«å–å¾—
    async function getAllVisitsWithBaseInfo() {
      const visits = await getAllVisits()
      
      const visitsWithBase = await Promise.all(visits.map(async (visit) => {
        const base = await db.getBase(visit.baseId)
        // éƒ½é“åºœçœŒåã‚’å–å¾—
        let prefName = ''
        if (base && base.pref_id) {
          prefName = PREF_NAMES[base.pref_id] || ''
        }
        return {
          ...visit,
          base: base || { id: visit.baseId, name: 'ä¸æ˜', lat: 0, lon: 0 },
          prefName: prefName,
          prefCode: base ? base.pref_id : ''
        }
      }))

      return visitsWithBase
    }

    // éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
    async function populatePrefList() {
      const prefMap = new Map()
      allVisits.forEach(visit => {
        if (visit.prefName && visit.prefCode) {
          prefMap.set(visit.prefCode, visit.prefName)
        }
      })
      
      // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedPrefCodes = Array.from(prefMap.keys()).sort()
      
      const prefFilter = document.getElementById('pref-filter')
      sortedPrefCodes.forEach(code => {
        const option = document.createElement('option')
        option.value = prefMap.get(code)
        option.textContent = prefMap.get(code)
        prefFilter.appendChild(option)
      })
    }

    // IndexedDBã‹ã‚‰å…¨è¨ªå•å±¥æ­´ã‚’å–å¾—
    function getAllVisits() {
      return new Promise((resolve, reject) => {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šãªã—ã§ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é–‹ã
        const request = indexedDB.open('visitHistoryDB')

        request.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'))

        request.onsuccess = (event) => {
          const db = event.target.result

          if (!db.objectStoreNames.contains('visits')) {
            db.close()
            resolve([])
            return
          }

          const transaction = db.transaction(['visits'], 'readonly')
          const store = transaction.objectStore('visits')
          const getRequest = store.getAll()

          getRequest.onsuccess = () => {
            db.close()
            resolve(getRequest.result || [])
          }

          getRequest.onerror = () => {
            db.close()
            reject(new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'))
          }
        }

        request.onupgradeneeded = (event) => {
          const db = event.target.result
          if (!db.objectStoreNames.contains('visits')) {
            const objectStore = db.createObjectStore('visits', { keyPath: 'visitId', autoIncrement: true })
            objectStore.createIndex('baseId', 'baseId', { unique: false })
            objectStore.createIndex('visitDate', 'visitDate', { unique: false })
          }
        }
      })
    }

    // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
    function addMarkersToMap(visits) {
      // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      markers.forEach(marker => marker.remove())
      markers = []

      // åŸºæº–ç‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæœ€æ–°ã®è¨ªå•ã®ã¿è¡¨ç¤ºï¼‰
      const baseMap = new Map()
      visits.forEach(visit => {
        if (!baseMap.has(visit.baseId) || new Date(visit.visitDate) > new Date(baseMap.get(visit.baseId).visitDate)) {
          baseMap.set(visit.baseId, visit)
        }
      })

      baseMap.forEach(visit => {
        const base = visit.base
        if (!base.lat || !base.lon) return

        const rankLabel = getLabel('rank_ids', base.rank_id) || 'ä¸æ˜'
        
        // ç‚¹ç¨®åˆ¥ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’é¸æŠ
        let iconUrl = 'assets/picture/default.png'
        if (rankLabel.includes('é›»å­')) {
          iconUrl = 'assets/picture/EL0.png'
        } else if (rankLabel.includes('ä¸€ç­‰')) {
          iconUrl = 'assets/picture/TR1.png'
        } else if (rankLabel.includes('äºŒç­‰')) {
          iconUrl = 'assets/picture/TR2.png'
        } else if (rankLabel.includes('ä¸‰ç­‰')) {
          iconUrl = 'assets/picture/TR3.png'
        } else if (rankLabel.includes('å››ç­‰')) {
          iconUrl = 'assets/picture/TR4.png'
        }

        const marker = L.marker([base.lat, base.lon], {
          icon: L.icon({
            iconUrl: iconUrl,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -12]
          })
        })

        let shortRank = rankLabel
        if (rankLabel.includes('é›»å­')) shortRank = 'é›»å­'
        else if (rankLabel.includes('ä¸€ç­‰')) shortRank = 'ä¸€ç­‰'
        else if (rankLabel.includes('äºŒç­‰')) shortRank = 'äºŒç­‰'
        else if (rankLabel.includes('ä¸‰ç­‰')) shortRank = 'ä¸‰ç­‰'
        else if (rankLabel.includes('å››ç­‰')) shortRank = 'å››ç­‰'

        const date = new Date(visit.visitDate)
        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`

        const popupContent = `
          <div class="popup-content">
            <div class="popup-rank">${shortRank}</div>
            <div class="popup-name">${base.name || 'åç§°ä¸æ˜'}</div>
            <div class="popup-info">æœ€çµ‚è¨ªå•: ${dateStr}</div>
            <a href="detail.html?id=${base.id}&tab=history" class="popup-btn">ğŸ“– è©³ç´°ã‚’è¦‹ã‚‹</a>
          </div>
        `

        marker.bindPopup(popupContent, {
          closeButton: false
        })
        marker.addTo(map)
        markers.push(marker)
      })
    }

    // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    function updateList(visits) {
      const listContent = document.getElementById('list-content')
      
      if (visits.length === 0) {
        listContent.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>'
        return
      }

      listContent.innerHTML = visits.map(visit => {
        const base = visit.base
        const rankLabel = getLabel('rank_ids', base.rank_id) || 'ä¸æ˜'
        let shortRank = rankLabel
        if (rankLabel.includes('é›»å­')) shortRank = 'é›»å­'
        else if (rankLabel.includes('ä¸€ç­‰')) shortRank = 'ä¸€ç­‰'
        else if (rankLabel.includes('äºŒç­‰')) shortRank = 'äºŒç­‰'
        else if (rankLabel.includes('ä¸‰ç­‰')) shortRank = 'ä¸‰ç­‰'
        else if (rankLabel.includes('å››ç­‰')) shortRank = 'å››ç­‰'

        const date = new Date(visit.visitDate)
        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`

        return `
          <div class="list-item" data-lat="${base.lat}" data-lon="${base.lon}" data-base-id="${base.id}">
            <div class="list-item-header">
              <div class="list-item-name">${base.name || 'åç§°ä¸æ˜'}</div>
              <div class="list-item-rank">${shortRank}</div>
            </div>
            <div class="list-item-info">
              <div class="list-item-date">${dateStr}</div>
              <div>${visit.prefName || ''}</div>
            </div>
          </div>
        `
      }).join('')

      // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', () => {
          const lat = parseFloat(item.dataset.lat)
          const lon = parseFloat(item.dataset.lon)
          
          // åœ°å›³ã‚’ç§»å‹•ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯
          map.setView([lat, lon], 15)
          
          // å¯¾å¿œã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
          markers.forEach(marker => {
            const markerLatLng = marker.getLatLng()
            if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lon) < 0.0001) {
              marker.openPopup()
            }
          })

          // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
          const panel = document.getElementById('list-panel')
          panel.classList.remove('show')
          document.getElementById('list-btn').classList.remove('hidden')
        })
      })
    }

    // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterAndSort() {
      const searchText = document.getElementById('search-box').value.toLowerCase()
      const selectedPref = document.getElementById('pref-filter').value
      
      let filtered = allVisits.filter(visit => {
        const base = visit.base
        const name = (base.name || '').toLowerCase()
        
        // ç‚¹åã§ã®æ¤œç´¢
        const nameMatch = name.includes(searchText)
        
        // éƒ½é“åºœçœŒã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const prefMatch = !selectedPref || visit.prefName === selectedPref
        
        return nameMatch && prefMatch
      })

      // ã‚½ãƒ¼ãƒˆ
      if (currentSort === 'date') {
        // æ¢ç´¢æ—¥é †ï¼ˆç¬¬äºŒã‚½ãƒ¼ãƒˆ: ç‚¹ç¨®åˆ¥ï¼‰
        filtered.sort((a, b) => {
          const dateCompare = new Date(b.visitDate) - new Date(a.visitDate)
          if (dateCompare !== 0) return dateCompare
          
          const rankA = a.base.rank_id || ''
          const rankB = b.base.rank_id || ''
          return rankA.localeCompare(rankB)
        })
      } else if (currentSort === 'rank') {
        // ç‚¹ç¨®åˆ¥é †ï¼ˆç¬¬äºŒã‚½ãƒ¼ãƒˆ: æ¢ç´¢æ—¥ï¼‰
        filtered.sort((a, b) => {
          const rankA = a.base.rank_id || ''
          const rankB = b.base.rank_id || ''
          const rankCompare = rankA.localeCompare(rankB)
          if (rankCompare !== 0) return rankCompare
          
          return new Date(b.visitDate) - new Date(a.visitDate)
        })
      }

      updateList(filtered)
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const listBtn = document.getElementById('list-btn')
    const listPanel = document.getElementById('list-panel')

    listBtn.addEventListener('click', (e) => {
      e.stopPropagation()
      listPanel.classList.toggle('show')
      listBtn.classList.toggle('hidden')
    })

    // åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
    document.getElementById('map').addEventListener('click', () => {
      listPanel.classList.remove('show')
      listBtn.classList.remove('hidden')
    })

    // ãƒ‘ãƒãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    listPanel.addEventListener('click', (e) => {
      if (e.target.id === 'list-panel') {
        listPanel.classList.remove('show')
        listBtn.classList.remove('hidden')
      }
    })

    document.getElementById('search-box').addEventListener('input', filterAndSort)

    document.getElementById('pref-filter').addEventListener('change', filterAndSort)

    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'))
        btn.classList.add('active')
        currentSort = btn.dataset.sort
        filterAndSort()
      })
    })

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init()
  </script>
</body>
</html>
