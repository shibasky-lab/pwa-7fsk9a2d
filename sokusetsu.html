<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>æ¸¬è¨­ãƒ¢ãƒ¼ãƒ‰</title>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0.8rem 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    header h1 {
      margin: 0;
      color: white;
      font-size: 1.2rem;
    }

    .home-btn {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: white;
      color: #667eea;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .home-btn:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .edit-btn {
      position: absolute;
      right: 4rem;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .edit-btn:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .list-btn {
      position: absolute;
      right: 7rem;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .list-btn:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .orientation-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 50px;
      height: 50px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 50;
      transition: all 0.2s;
    }

    .orientation-btn:active {
      transform: scale(0.95);
    }

    .orientation-btn.north-up {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #764ba2;
    }

    #radar-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
    }

    #radar {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    .coord-display {
      position: absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-family: monospace;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 50;
    }

    .target-info {
      position: fixed;
      top: 70px;
      left: 10px;
      max-width: calc(100% - 20px);
      width: auto;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 60;
    }

    .target-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #1976D2;
      margin-bottom: 0.3rem;
    }

    .target-id {
      font-size: 0.85rem;
      color: #666;
      font-family: monospace;
      margin-bottom: 0.8rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      font-size: 0.85rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-item-label {
      font-weight: 600;
      color: #555;
      font-size: 0.75rem;
      margin-bottom: 0.2rem;
    }

    .info-item-value {
      color: #333;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.4rem;
    }

    .status-active {
      background: #4CAF50;
      box-shadow: 0 0 6px #4CAF50;
    }

    .status-inactive {
      background: #f44336;
    }

    /* åº§æ¨™å…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #coord-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    #coord-popup.hidden {
      display: none;
    }

    .popup-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 450px;
      width: 85%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .popup-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 1rem;
      text-align: center;
    }

    .format-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: #f0f0f0;
      padding: 0.3rem;
      border-radius: 8px;
    }

    .format-toggle button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .format-toggle button.active {
      background: white;
      color: #667eea;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 0.3rem;
    }

    .input-group input {
      width: 100%;
      padding: 0.7rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: monospace;
      box-sizing: border-box;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .dms-inputs {
      display: flex;
      gap: 0.5rem;
    }

    .dms-inputs input {
      flex: 1;
    }

    .popup-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .popup-buttons button {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #666;
    }

    .btn-cancel:active {
      transform: scale(0.98);
    }

    .btn-ok {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-ok:active {
      transform: scale(0.98);
    }

    .format-hint {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.3rem;
    }

    /* è¿‘éš£ç‚¹ãƒªã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #nearby-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    #nearby-popup.hidden {
      display: none;
    }

    .nearby-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 450px;
      width: 85%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .nearby-loading {
      text-align: center;
      padding: 2rem;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .nearby-list {
      overflow-y: auto;
      margin-top: 1rem;
    }

    .nearby-item {
      padding: 0.8rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nearby-item:hover {
      background: #f5f5f5;
      border-color: #667eea;
    }

    .nearby-item-left {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    .nearby-item-rank {
      font-size: 0.85rem;
      color: #666;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .nearby-item-name {
      font-weight: bold;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 1;
    }

    .nearby-item-info {
      font-size: 0.85rem;
      color: #666;
      white-space: nowrap;
    }

    .nearby-item-distance {
      font-size: 0.9rem;
      color: #667eea;
      font-weight: bold;
      white-space: nowrap;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <!-- åº§æ¨™å…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="coord-popup" class="hidden">
    <div class="popup-content">
      <div class="popup-title">ğŸ“ æ¸¬è¨­åº§æ¨™ã‚’å…¥åŠ›</div>
      
      <div class="format-toggle">
        <button id="format-decimal">åº¦å°æ•°</button>
        <button id="format-dms" class="active">åº¦åˆ†ç§’</button>
      </div>

      <!-- åº¦å°æ•°å½¢å¼ -->
      <div id="decimal-inputs" style="display: none;">
        <div class="input-group">
          <label>ç·¯åº¦ (Latitude)</label>
          <input type="text" id="lat-decimal" placeholder="35.71772228" inputmode="decimal">
          <div class="format-hint">ä¾‹: 35.71772228</div>
        </div>
        <div class="input-group">
          <label>çµŒåº¦ (Longitude)</label>
          <input type="text" id="lon-decimal" placeholder="139.48102264" inputmode="decimal">
          <div class="format-hint">ä¾‹: 139.48102264</div>
        </div>
      </div>

      <!-- åº¦åˆ†ç§’å½¢å¼ -->
      <div id="dms-inputs">
        <div class="input-group">
          <label>ç·¯åº¦ (Latitude)</label>
          <input type="text" id="lat-dms" placeholder="354303.8002" inputmode="decimal">
          <div class="format-hint">ä¾‹: 354303.8002 (35åº¦43åˆ†3.8002ç§’)</div>
        </div>
        <div class="input-group">
          <label>çµŒåº¦ (Longitude)</label>
          <input type="text" id="lon-dms" placeholder="1392851.6815" inputmode="decimal">
          <div class="format-hint">ä¾‹: 1392851.6815 (139åº¦28åˆ†51.6815ç§’)</div>
        </div>
      </div>

      <div class="popup-buttons">
        <button class="btn-cancel" id="coord-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-ok" id="coord-ok">æ¸¬è¨­é–‹å§‹</button>
      </div>
    </div>
  </div>

  <header>
    <h1>ğŸ¯ æ¸¬è¨­ãƒ¢ãƒ¼ãƒ‰</h1>
    <button id="list-btn" class="list-btn" title="è¿‘éš£ç‚¹ãƒªã‚¹ãƒˆ">ğŸ“‹</button>
    <button id="edit-btn" class="edit-btn" title="åº§æ¨™ã‚’å…¥åŠ›">âœï¸</button>
    <a href="index.html" class="home-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </a>
  </header>

  <!-- è¿‘éš£ç‚¹ãƒªã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="nearby-popup" class="hidden">
    <div class="nearby-content">
      <div class="popup-title">ğŸ“ è¿‘éš£ã®åŸºæº–ç‚¹</div>
      <div id="nearby-loading" class="nearby-loading">
        <div class="spinner"></div>
        <p>è¿‘éš£ã®åŸºæº–ç‚¹ã‚’æ¤œç´¢ä¸­...</p>
      </div>
      <div id="nearby-list" class="nearby-list" style="display: none;"></div>
      <button class="btn-cancel" id="nearby-cancel" style="margin-top: 1rem; display: none; width: auto; padding: 0.6rem 1.5rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="target-info">
    <div class="target-name" id="target-name">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="target-id" id="target-id"></div>
    
    <div class="info-grid">
      <div class="info-item">
        <div class="info-item-label">
          <span class="status-indicator" id="gps-status"></span>
          GPSçŠ¶æ…‹
        </div>
        <div class="info-item-value" id="gps-status-text">å–å¾—ä¸­...</div>
      </div>
      <div class="info-item">
        <div class="info-item-label">ç²¾åº¦</div>
        <div class="info-item-value" id="gps-accuracy">--</div>
      </div>
      <div class="info-item">
        <div class="info-item-label">æ–¹ä½</div>
        <div class="info-item-value" id="bearing">--</div>
      </div>
      <div class="info-item">
        <div class="info-item-label">è·é›¢</div>
        <div class="info-item-value" id="distance">--</div>
      </div>
    </div>
  </div>

  <div id="radar-container">
    <canvas id="radar" width="600" height="600"></canvas>
    <button id="orientation-btn" class="orientation-btn" title="æ–¹å‘ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
      ğŸ§­
    </button>
    <div class="coord-display" id="current-pos">--</div>
  </div>

  <script type="module">
    import KijuntenDB from './src/db.js'
    import { getLabel, ensureMasterDataLoaded } from './src/metadata.js'

    const db = new KijuntenDB()
    const canvas = document.getElementById('radar')
    const ctx = canvas.getContext('2d')
    
    let currentPosition = null
    let targetBase = null
    let watchId = null
    let deviceHeading = 0 // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãï¼ˆåº¦ï¼‰
    let northUp = false // false=ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒƒãƒ—ã€true=ãƒãƒ¼ã‚¹ã‚¢ãƒƒãƒ—

    // å††ã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    const circles = [5, 25, 50]
    const maxRadius = 50 // æœ€å¤§è¡¨ç¤ºç¯„å›²

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç›®æ¨™IDã‚’å–å¾—
    const params = new URLSearchParams(window.location.search)
    const targetId = params.get('id')

    // åˆæœŸåŒ–
    async function init() {
      try {
        await db.init()
        
        // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('edit-btn').addEventListener('click', showCoordPopup)
        
        // ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('list-btn').addEventListener('click', showNearbyList)
        
        // ç›®æ¨™ç‚¹ã‚’æ±ºå®š
        if (targetId) {
          // detail.htmlã‹ã‚‰é·ç§»ã—ãŸå ´åˆ
          targetBase = await db.getBase(targetId)
          localStorage.setItem('last_sokusetsu_target', targetId)
          startSokusetsu()
        } else {
          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é–‹ã„ãŸå ´åˆï¼šè¿‘éš£ç‚¹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
          showNearbyList()
        }
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error)
        document.getElementById('target-name').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
      }
    }

    // æ¸¬è¨­ã‚’é–‹å§‹
    function startSokusetsu() {
      if (targetBase) {
        // å…¥åŠ›åº§æ¨™ã®å ´åˆã¨åŸºæº–ç‚¹ã®å ´åˆã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (targetBase.id === 'custom') {
          // å…¥åŠ›åº§æ¨™ã®å ´åˆ
          document.getElementById('target-name').textContent = 'å…¥åŠ›åº§æ¨™'
          document.getElementById('target-id').textContent = `${targetBase.lat.toFixed(8)}, ${targetBase.lon.toFixed(8)}`
        } else {
          // åŸºæº–ç‚¹ã®å ´åˆ
          document.getElementById('target-name').textContent = targetBase.name || 'åç§°ä¸æ˜'
          document.getElementById('target-id').textContent = targetBase.id
        }
      } else {
        document.getElementById('target-name').textContent = 'ç›®æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
        document.getElementById('target-id').textContent = ''
      }

      // ä½ç½®æƒ…å ±ã®ç›£è¦–ã‚’é–‹å§‹
      startLocationWatch()
      
      // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚’ç›£è¦–é–‹å§‹
      startOrientationWatch()
      
      // ãƒ¬ãƒ¼ãƒ€ãƒ¼æç”»é–‹å§‹
      drawRadar()
      
      // æ–¹å‘ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³
      document.getElementById('orientation-btn').addEventListener('click', toggleOrientationMode)
      updateOrientationButton()
    }

    // è¿‘éš£ç‚¹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    async function showNearbyList() {
      const popup = document.getElementById('nearby-popup')
      const loading = document.getElementById('nearby-loading')
      const listDiv = document.getElementById('nearby-list')
      const cancelBtn = document.getElementById('nearby-cancel')
      
      popup.classList.remove('hidden')
      loading.style.display = 'block'
      listDiv.style.display = 'none'
      cancelBtn.style.display = 'none'
      
      try {
        // ç¾åœ¨ä½ç½®ã‚’å–å¾—
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          })
        })
        
        const currentLat = position.coords.latitude
        const currentLon = position.coords.longitude
        
        // å…¨åŸºæº–ç‚¹ã‚’å–å¾—
        const allBases = await db.getAllBases()
        
        // è·é›¢ã‚’è¨ˆç®—ã—ã¦ã‚½ãƒ¼ãƒˆ
        const basesWithDistance = allBases.map(base => ({
          ...base,
          distance: calculateDistance(currentLat, currentLon, base.lat, base.lon)
        }))
        
        basesWithDistance.sort((a, b) => a.distance - b.distance)
        
        // ä¸Šä½30ç‚¹ã‚’è¡¨ç¤º
        const nearbyBases = basesWithDistance.slice(0, 30)
        
        loading.style.display = 'none'
        listDiv.style.display = 'block'
        cancelBtn.style.display = 'block'
        
        listDiv.innerHTML = nearbyBases.map(base => {
          // rank_idã‚’ãƒ©ãƒ™ãƒ«ã«å¤‰æ›ã—ã¦çŸ­ç¸®è¡¨ç¤º
          const rankLabel = getLabel('rank_ids', base.rank_id)
          let shortRank = rankLabel
          if (rankLabel.includes('é›»å­')) shortRank = 'é›»å­'
          else if (rankLabel.includes('ä¸€ç­‰')) shortRank = 'ä¸€ç­‰'
          else if (rankLabel.includes('äºŒç­‰')) shortRank = 'äºŒç­‰'
          else if (rankLabel.includes('ä¸‰ç­‰')) shortRank = 'ä¸‰ç­‰'
          else if (rankLabel.includes('å››ç­‰')) shortRank = 'å››ç­‰'
          
          return `
            <div class="nearby-item" data-id="${base.id}">
              <div class="nearby-item-left">
                <span class="nearby-item-rank">${shortRank}</span>
                <span class="nearby-item-name">ã€€ã€€${base.name || 'åç§°ä¸æ˜'}</span>
              </div>
              <div class="nearby-item-distance">
                ${base.distance < 1000 ? `${base.distance.toFixed(1)}m` : `${(base.distance / 1000).toFixed(2)}km`}
              </div>
            </div>
          `
        }).join('')
        
        // å„ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        listDiv.querySelectorAll('.nearby-item').forEach(item => {
          item.addEventListener('click', async () => {
            const baseId = item.dataset.id
            targetBase = await db.getBase(baseId)
            popup.classList.add('hidden')
            startSokusetsu()
          })
        })
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        cancelBtn.addEventListener('click', () => {
          popup.classList.add('hidden')
        })
        
      } catch (error) {
        console.error('è¿‘éš£ç‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        loading.innerHTML = '<p style="color: #f44336;">ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p><button class="btn-cancel" onclick="window.location.href=\'index.html\'">æˆ»ã‚‹</button>'
      }
    }

    // åº§æ¨™å…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    function showCoordPopup() {
      const popup = document.getElementById('coord-popup')
      popup.classList.remove('hidden')
      
      // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ‡æ›¿
      document.getElementById('format-decimal').addEventListener('click', () => {
        document.getElementById('format-decimal').classList.add('active')
        document.getElementById('format-dms').classList.remove('active')
        document.getElementById('decimal-inputs').style.display = 'block'
        document.getElementById('dms-inputs').style.display = 'none'
      })
      
      document.getElementById('format-dms').addEventListener('click', () => {
        document.getElementById('format-dms').classList.add('active')
        document.getElementById('format-decimal').classList.remove('active')
        document.getElementById('decimal-inputs').style.display = 'none'
        document.getElementById('dms-inputs').style.display = 'block'
      })
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      document.getElementById('coord-cancel').addEventListener('click', () => {
        popup.classList.add('hidden')
      })
      
      // OKãƒœã‚¿ãƒ³
      document.getElementById('coord-ok').addEventListener('click', () => {
        const isDecimal = document.getElementById('format-decimal').classList.contains('active')
        let lat, lon
        
        if (isDecimal) {
          // åº¦å°æ•°å½¢å¼
          lat = parseFloat(document.getElementById('lat-decimal').value)
          lon = parseFloat(document.getElementById('lon-decimal').value)
        } else {
          // åº¦åˆ†ç§’å½¢å¼
          const latDMS = document.getElementById('lat-dms').value
          const lonDMS = document.getElementById('lon-dms').value
          lat = dmsToDecimal(latDMS)
          lon = dmsToDecimal(lonDMS)
        }
        
        if (isNaN(lat) || isNaN(lon)) {
          alert('æ­£ã—ã„åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
          return
        }
        
        // ç›®æ¨™åº§æ¨™ã‚’è¨­å®š
        targetBase = {
          id: 'custom',
          name: 'å…¥åŠ›åº§æ¨™',
          lat: lat,
          lon: lon
        }
        
        popup.classList.add('hidden')
        startSokusetsu()
      })
    }
    
    // åº¦åˆ†ç§’ã‚’åº¦å°æ•°ã«å¤‰æ›
    function dmsToDecimal(dmsString) {
      // dmsStringå½¢å¼: "354303.8002" (35åº¦43åˆ†03.8002ç§’)
      const str = dmsString.replace(/[^0-9.]/g, '')
      if (str.length < 7) return NaN
      
      // å°æ•°ç‚¹ã®ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹
      const dotIndex = str.indexOf('.')
      let integerPart, decimalPart
      
      if (dotIndex !== -1) {
        // å°æ•°ç‚¹ãŒã‚ã‚‹å ´åˆ
        integerPart = str.substring(0, dotIndex)
        decimalPart = str.substring(dotIndex) // .ã‚’å«ã‚€
      } else {
        // å°æ•°ç‚¹ãŒãªã„å ´åˆ
        integerPart = str
        decimalPart = ''
      }
      
      // æ•´æ•°éƒ¨åˆ†ã‹ã‚‰åº¦ãƒ»åˆ†ãƒ»ç§’ã‚’æŠ½å‡º
      // å¾Œã‚ã‹ã‚‰2æ¡ãŒç§’ã®æ•´æ•°éƒ¨ã€ãã®å‰2æ¡ãŒåˆ†ã€æ®‹ã‚ŠãŒåº¦
      const secondsInt = parseInt(integerPart.substring(integerPart.length - 2))
      const minutes = parseInt(integerPart.substring(integerPart.length - 4, integerPart.length - 2))
      const degrees = parseInt(integerPart.substring(0, integerPart.length - 4))
      
      // ç§’ã‚’å®Œå…¨ãªæ•°å€¤ã«ï¼ˆæ•´æ•°éƒ¨ + å°æ•°éƒ¨ï¼‰
      const seconds = parseFloat(secondsInt + decimalPart)
      
      // åº¦å°æ•°ã«å¤‰æ›ï¼ˆå°æ•°ç‚¹ç¬¬8ä½ã«å››æ¨äº”å…¥ï¼‰
      const decimal = degrees + (minutes / 60) + (seconds / 3600)
      return parseFloat(decimal.toFixed(8))
    }

    // ä½ç½®æƒ…å ±ã®ç›£è¦–é–‹å§‹
    function startLocationWatch() {
      if (!navigator.geolocation) {
        document.getElementById('gps-status-text').textContent = 'éå¯¾å¿œ'
        document.getElementById('gps-status').className = 'status-indicator status-inactive'
        return
      }

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          currentPosition = {
            lat: position.coords.latitude,
            lon: position.coords.longitude,
            accuracy: position.coords.accuracy
          }
          
          document.getElementById('gps-status-text').textContent = 'å–å¾—ä¸­'
          document.getElementById('gps-status').className = 'status-indicator status-active'
          document.getElementById('current-pos').textContent = 
            `${currentPosition.lat.toFixed(6)}, ${currentPosition.lon.toFixed(6)}`
          
          // GPSç²¾åº¦ã‚’è¡¨ç¤º
          if (position.coords.accuracy) {
            document.getElementById('gps-accuracy').textContent = 
              `Â±${position.coords.accuracy.toFixed(1)}m`
          }
          
          updateDistance()
        },
        (error) => {
          console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error)
          document.getElementById('gps-status-text').textContent = 'ã‚¨ãƒ©ãƒ¼'
          document.getElementById('gps-status').className = 'status-indicator status-inactive'
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      )
    }

    // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚’ç›£è¦–é–‹å§‹
    function startOrientationWatch() {
      if (window.DeviceOrientationEvent) {
        // iOS 13+ã§ã®è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                window.addEventListener('deviceorientationabsolute', handleOrientation, true)
                window.addEventListener('deviceorientation', handleOrientation, true)
              }
            })
            .catch(console.error)
        } else {
          // Androidç­‰
          window.addEventListener('deviceorientationabsolute', handleOrientation, true)
          window.addEventListener('deviceorientation', handleOrientation, true)
        }
      }
    }

    // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚’å‡¦ç†
    function handleOrientation(event) {
      if (event.webkitCompassHeading) {
        // iOS
        deviceHeading = event.webkitCompassHeading
      } else if (event.alpha !== null) {
        // Android (absolute)
        deviceHeading = 360 - event.alpha
      }
    }

    // 2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000 // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
      const Ï†1 = lat1 * Math.PI / 180
      const Ï†2 = lat2 * Math.PI / 180
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180
      const Î”Î» = (lon2 - lon1) * Math.PI / 180

      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2)
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))

      return R * c
    }

    // æ–¹ä½è§’ã‚’è¨ˆç®—ï¼ˆåº¦ï¼‰
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = lat1 * Math.PI / 180
      const Ï†2 = lat2 * Math.PI / 180
      const Î”Î» = (lon2 - lon1) * Math.PI / 180

      const y = Math.sin(Î”Î») * Math.cos(Ï†2)
      const x = Math.cos(Ï†1) * Math.sin(Ï†2) -
                Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»)
      
      const Î¸ = Math.atan2(y, x)
      return (Î¸ * 180 / Math.PI + 360) % 360
    }

    // è·é›¢ã¨æ–¹ä½ã‚’æ›´æ–°
    function updateDistance() {
      if (!currentPosition || !targetBase) return

      const distance = calculateDistance(
        currentPosition.lat, currentPosition.lon,
        targetBase.lat, targetBase.lon
      )
      
      const bearing = calculateBearing(
        currentPosition.lat, currentPosition.lon,
        targetBase.lat, targetBase.lon
      )

      // è·é›¢è¡¨ç¤º
      if (distance < 1000) {
        document.getElementById('distance').textContent = `${distance.toFixed(1)}m`
      } else {
        document.getElementById('distance').textContent = `${(distance / 1000).toFixed(2)}km`
      }

      // æ–¹ä½è¡¨ç¤º
      const directions = ['åŒ—', 'åŒ—åŒ—æ±', 'åŒ—æ±', 'æ±åŒ—æ±', 'æ±', 'æ±å—æ±', 'å—æ±', 'å—å—æ±',
                         'å—', 'å—å—è¥¿', 'å—è¥¿', 'è¥¿å—è¥¿', 'è¥¿', 'è¥¿åŒ—è¥¿', 'åŒ—è¥¿', 'åŒ—åŒ—è¥¿']
      const index = Math.round(bearing / 22.5) % 16
      document.getElementById('bearing').textContent = 
        `${bearing.toFixed(1)}Â° (${directions[index]})`
    }

    // æ–¹å‘ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function toggleOrientationMode() {
      northUp = !northUp
      updateOrientationButton()
    }

    // æ–¹å‘ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
    function updateOrientationButton() {
      const btn = document.getElementById('orientation-btn')
      if (northUp) {
        btn.classList.add('north-up')
        btn.textContent = 'ğŸ§­'
        btn.title = 'ãƒãƒ¼ã‚¹ã‚¢ãƒƒãƒ—'
      } else {
        btn.classList.remove('north-up')
        btn.textContent = 'ğŸ“±'
        btn.title = 'ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒƒãƒ—'
      }
    }

    // ãƒ¬ãƒ¼ãƒ€ãƒ¼æç”»
    function drawRadar() {
      const width = canvas.width
      const height = canvas.height
      const centerX = width / 2
      const centerY = height / 2
      const scale = Math.min(width, height) / 2 * 0.85

      // èƒŒæ™¯ã‚¯ãƒªã‚¢ï¼ˆç™½ï¼‰
      ctx.fillStyle = '#ffffff'
      ctx.fillRect(0, 0, width, height)

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å›è»¢ï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ï¼‰
      ctx.save()
      ctx.translate(centerX, centerY)
      if (!northUp) {
        // ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã«åˆã‚ã›ã¦å›è»¢
        ctx.rotate((-deviceHeading) * Math.PI / 180)
      }
      // ãƒãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã¯å›è»¢ãªã—
      ctx.translate(-centerX, -centerY)

      // å††ã‚’æç”»ï¼ˆç™½é»’ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰- å¤§ãã„å††ã‹ã‚‰æç”»
      circles.slice().reverse().forEach((radius, index) => {
        const r = (radius / maxRadius) * scale
        const originalIndex = circles.length - 1 - index
        
        // å††ã®å¡—ã‚Šã¤ã¶ã—ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
        ctx.fillStyle = originalIndex % 2 === 0 ? '#f5f5f5' : '#e0e0e0'
        ctx.beginPath()
        ctx.arc(centerX, centerY, r, 0, 2 * Math.PI)
        ctx.fill()

        // å††å‘¨ï¼ˆé»’ï¼‰
        ctx.strokeStyle = '#333333'
        ctx.lineWidth = 2
        ctx.stroke()

        // è·é›¢ãƒ©ãƒ™ãƒ«ï¼ˆé»’ï¼‰
        ctx.fillStyle = '#000000'
        ctx.font = '14px sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(`${radius}m`, centerX, centerY - r + 20)
      })

      // 8æ–¹ä½ç·šï¼ˆé»’ï¼‰
      for (let i = 0; i < 8; i++) {
        const angle = (i * 45) * Math.PI / 180
        ctx.strokeStyle = '#666666'
        ctx.lineWidth = 1
        ctx.beginPath()
        ctx.moveTo(centerX, centerY)
        ctx.lineTo(
          centerX + Math.cos(angle - Math.PI/2) * scale,
          centerY + Math.sin(angle - Math.PI/2) * scale
        )
        ctx.stroke()

        // æ–¹ä½ãƒ©ãƒ™ãƒ«ï¼ˆé»’ï¼‰
        const labelRadius = scale + 20
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW']
        ctx.fillStyle = '#000000'
        ctx.font = 'bold 16px sans-serif'
        ctx.textAlign = 'center'
        ctx.textBaseline = 'middle'
        ctx.fillText(
          directions[i],
          centerX + Math.cos(angle - Math.PI/2) * labelRadius,
          centerY + Math.sin(angle - Math.PI/2) * labelRadius
        )
      }

      // ä¸­å¿ƒç‚¹ï¼ˆç¾åœ¨åœ°ï¼šç·‘ï¼‰
      ctx.fillStyle = '#4CAF50'
      ctx.beginPath()
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI)
      ctx.fill()
      ctx.strokeStyle = 'white'
      ctx.lineWidth = 2
      ctx.stroke()

      // ç›®æ¨™ç‚¹ã‚’æç”»
      if (currentPosition && targetBase) {
        const distance = calculateDistance(
          currentPosition.lat, currentPosition.lon,
          targetBase.lat, targetBase.lon
        )
        
        const bearing = calculateBearing(
          currentPosition.lat, currentPosition.lon,
          targetBase.lat, targetBase.lon
        )

        // è¡¨ç¤ºç¯„å›²å†…ãªã‚‰ç›®æ¨™ã‚’æç”»
        if (distance <= maxRadius) {
          const r = (distance / maxRadius) * scale
          const angle = bearing * Math.PI / 180
          const x = centerX + Math.cos(angle - Math.PI/2) * r
          const y = centerY + Math.sin(angle - Math.PI/2) * r

          // ç›®æ¨™ç‚¹
          ctx.fillStyle = '#ff5252'
          ctx.beginPath()
          ctx.arc(x, y, 12, 0, 2 * Math.PI)
          ctx.fill()
          
          ctx.strokeStyle = 'white'
          ctx.lineWidth = 3
          ctx.stroke()

          // ãƒ‘ãƒ«ã‚¹åŠ¹æœ
          const pulseRadius = 12 + Math.sin(Date.now() / 200) * 5
          ctx.strokeStyle = 'rgba(255, 82, 82, 0.5)'
          ctx.lineWidth = 2
          ctx.beginPath()
          ctx.arc(x, y, pulseRadius, 0, 2 * Math.PI)
          ctx.stroke()

          // ç‚¹ç·šï¼ˆé»’ï¼‰
          ctx.strokeStyle = '#333333'
          ctx.lineWidth = 2
          ctx.setLineDash([5, 5])
          ctx.beginPath()
          ctx.moveTo(centerX, centerY)
          ctx.lineTo(x, y)
          ctx.stroke()
          ctx.setLineDash([])
        } else {
          // ç¯„å›²å¤–ã®å ´åˆã€æ–¹å‘ã®ã¿è¡¨ç¤º
          const angle = bearing * Math.PI / 180
          const arrowX = centerX + Math.cos(angle - Math.PI/2) * (scale * 0.9)
          const arrowY = centerY + Math.sin(angle - Math.PI/2) * (scale * 0.9)

          // çŸ¢å°ï¼ˆèµ¤ï¼‰
          ctx.fillStyle = '#ff5252'
          ctx.strokeStyle = 'white'
          ctx.lineWidth = 2
          ctx.beginPath()
          ctx.moveTo(arrowX, arrowY)
          ctx.lineTo(
            arrowX - Math.cos(angle - Math.PI/2 - 0.4) * 15,
            arrowY - Math.sin(angle - Math.PI/2 - 0.4) * 15
          )
          ctx.lineTo(
            arrowX - Math.cos(angle - Math.PI/2 + 0.4) * 15,
            arrowY - Math.sin(angle - Math.PI/2 + 0.4) * 15
          )
          ctx.closePath()
          ctx.fill()
          ctx.stroke()
        }
      }

      // å›è»¢ã‚’å…ƒã«æˆ»ã™
      ctx.restore()

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
      requestAnimationFrame(drawRadar)
    }

    // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹æ™‚ã«ç›£è¦–ã‚’åœæ­¢
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId)
      }
    })

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init()
  </script>
</body>
</html>
